# This pipeline performs the SAP systems and storage deployments

parameters:
- name: sap_system
  displayName: ENV-LOCA-VNET-SID
  type: string
  default: DEV-WEEU-SAP01-X00

trigger:
  none

pool:
  vmImage: ubuntu-latest

variables:
  sapsystemfolder: ${{ parameters.sap_system }}
  sapsystemconfig: ${{ parameters.sap_system }}.tfvars
  log: logfile_$(Build.BuildId)

name: $(sapsystemfolder)_$(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:.r)

stages:
- stage: Deploy_SAP_infrastructure
  jobs:
  - job: Deploy_SAP_infrastructure
    steps:
    - script: |
        #!/bin/bash
        green="\e[1;32m"
        reset="\e[0m"
        SID=$(echo $(sapsystemfolder) | cut -d'-' -f4 | xargs) 
        echo -e "$green--- Install Terraform ---$reset"
          wget -q https://releases.hashicorp.com/terraform/1.0.8/terraform_1.0.8_linux_amd64.zip
          unzip -qq terraform_1.0.8_linux_amd64.zip
          sudo mv terraform /bin/ ; rm terraform_1.0.8_linux_amd64.zip
        echo -e "$green--- Clone the $(Branch) branch of repository $(Repository) ---$reset"
          git clone --quiet --single-branch --branch $(Branch) $(Repository) 
        echo -e "$green--- Set DEPLOYMENT_REPO_PATH variable and ---$reset"
        echo -e "$green--- Update .sap_deployment_automation/config as DEPLOYMENT_REPO_PATH can change on devops agent ---$reset"
          export DEPLOYMENT_REPO_PATH=$(Build.Repository.LocalPath)/sap-automation
        echo -e "$green--- Set WORKSPACES folder as new home ---$reset"
          export HOME=$(Build.Repository.LocalPath)/$(Deployment_Configuration_Path)
          cd $HOME; mkdir -p .sap_deployment_automation
          echo DEPLOYMENT_REPO_PATH=$DEPLOYMENT_REPO_PATH > .sap_deployment_automation/config
        echo -e "$green--- az login ---$reset"
          export ARM_SUBSCRIPTION_ID=$(ARM_SUBSCRIPTION_ID)
          export ARM_CLIENT_ID=$(ARM_CLIENT_ID)
          export ARM_CLIENT_SECRET=$(ARM_CLIENT_SECRET)
          export ARM_TENANT_ID=$(ARM_TENANT_ID)
          az login --service-principal --username $(ARM_CLIENT_ID) --password $(ARM_CLIENT_SECRET) --tenant $(ARM_TENANT_ID)
          az account set --subscription $(ARM_SUBSCRIPTION_ID)
        echo -e "$green--- --- Convert config file to UX format ---$reset"
          sudo apt-get -qq install dos2unix
          dos2unix -q SYSTEM/$(sapsystemfolder)/$(sapsystemconfig)
        echo -e "$green--- Prepare the exchange of information from devops agent back to the repository ---$reset"
          organization=$(echo $(System.CollectionUri) | cut -d'/' -f4)
          git config  http.https://$organization@dev.azure.com/$organization/$(System.TeamProject)/_git/$(Build.Repository.Name).extraheader "AUTHORIZATION: bearer $SYSTEM_ACCESSTOKEN"
        echo -e "$green--- Run the installer script that deploys the SAP System ---$reset"
          cd $HOME/SYSTEM/$(sapsystemfolder)
          ${DEPLOYMENT_REPO_PATH}/deploy/scripts/installer.sh --parameterfile $(sapsystemconfig) --type sap_system --ado --auto-approve 2> err.log
          return_value=$?
          cat err.log
        echo -e "$green--- Add & update files in the DevOps Repository ---$reset"
          cd $(Build.Repository.LocalPath)
          if [ 0 == $return_value ] ; then
            rm $(Deployment_Configuration_Path)/.sap_deployment_automation/config
            git config --global user.email "$(Build.RequestedForEmail)"
            git config --global user.name "$(Build.RequestedFor)" 
            git add $(Deployment_Configuration_Path)/.sap_deployment_automation                               &>> /tmp/$(log)2
            git add $(Deployment_Configuration_Path)/SYSTEM/$(sapsystemfolder)/.terraform/terraform.tfstate   &>> /tmp/$(log)2
            git add $(Deployment_Configuration_Path)/SYSTEM/$(sapsystemfolder)/sap-parameters.yaml            &>> /tmp/$(log)2
            git add $(Deployment_Configuration_Path)/SYSTEM/$(sapsystemfolder)/${SID}_hosts.yaml              &>> /tmp/$(log)2
            git commit -m "Added updates from devops deployment $(Build.DefinitionName) [skip ci]"            &>> /tmp/$(log)2
            git pull origin $(Branch)                                                                         &>> /tmp/$(log)2
            git push -f origin HEAD:$(Branch)                                                                 &>> /tmp/$(log)2
            echo "output the log ---$reset"
            cat /tmp/$(log)2
          fi
        git config --unset-all http.https://$organization@dev.azure.com/$organization/$(System.TeamProject)/_git/$(Build.Repository.Name).extraheader
        exit $return_code
      displayName: Deploy_SAP_infrastructure
      env:
        SYSTEM_ACCESSTOKEN: $(System.AccessToken)
      failOnStderr: false