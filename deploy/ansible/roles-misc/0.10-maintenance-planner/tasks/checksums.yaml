---

- name:                        "BOM: Verify Files"
  ansible.builtin.stat:
    path:                      "{{ sap_download_dir }}/{{ bom_media_entry.archive }}"
    checksum_algorithm:        sha256
  register:                    fs_check

- name:                        "BOM: Show"
  ansible.builtin.debug:
    var:                       fs_check
    verbosity:                 1


- name:                                "BOM: Line"
  ansible.builtin.blockinfile:
    path:                              "{{ bom_file }}"
    insertafter:                       '      archive:      {{ bom_media_entry.archive }}'
    block:                             "      checksum:     {{ fs_check.stat.checksum }}"
    marker:                            "# {mark} ANSIBLE MANAGED BLOCK {{ bom_media_entry.archive }}"
  when:
    - fs_check is defined

- name:                                "BOM: Remove marker"
  ansible.builtin.lineinfile:
    path:                              "{{ bom_file }}"
    regexp:                            '# BEGIN ANSIBLE MANAGED BLOCK {{ bom_media_entry.archive }}'
    state:                             absent

- name:                                "BOM: Remove marker"
  ansible.builtin.lineinfile:
    path:                              "{{ bom_file }}"
    regexp:                            '# END ANSIBLE MANAGED BLOCK {{ bom_media_entry.archive }}'
    state:                             absent

- name:                                "Update BOM"
  ansible.builtin.set_fact:
    bom:                               "{{ bom_update }}"
  vars:
    bom_update:                        "{#- -#}{% set _ = bom.materials.media[bom_media_index].update({'checksum': fs_check.stat.checksum}) -%} {{ bom }}"

- name:                                "BOM: Show"
  ansible.builtin.debug:
    var:                               bom.materials.media[bom_media_index]
    verbosity:                         1


...
# /*---------------------------------------------------------------------------8
# |                                   END                                      |
# +------------------------------------4--------------------------------------*/
