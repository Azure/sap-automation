# /*---------------------------------------------------------------------------8
# |                                                                            |
# |                         Key Vault helpers                                  |
# |                                                                            |
# +------------------------------------4--------------------------------------*/
---
# -------------------------------------+---------------------------------------8
#
# Task: 0.2     - kv-secrets
#
# -------------------------------------+---------------------------------------8

# -------------------------------------+---------------------------------------8
#
# <Comment Header>
#
# -------------------------------------+---------------------------------------8

# -------------------------------------+---------------------------------------8
#

- name:                                "BoM Secrets: Retrieve Deployer Keyvault details"  
  block:

    - name:                            Check required variables are present and not empty
      ansible.builtin.assert:
        that:
          - "kv_name is defined"                    # Has the variable been defined
          - "kv_name | type_debug != 'NoneType'"    # and given a value
          - "kv_name | string | length != 0 "       # Detect null values
        fail_msg:                          "Please define the kv_name parameter"

    - name:                            Get Deployer Keyvault name from keyvault
      ansible.builtin.command: >-
                                       az keyvault secret show
                                         --vault-name {{ kv_name }}
                                         --name {{ deployer_kv_name_secret }}
      changed_when:                    false
      register:                        deployer_kv_name_secret
      when:                            bom_processing is not defined

    - name:                            Save Deployer Keyvault name
      ansible.builtin.set_fact:
        deployer_kv_name: >-
                                       {{ (deployer_kv_name_secret.stdout | from_json).value }}
  when: deployer_kv_name is not defined 


- name:                                Show Key Vault
  ansible.builtin.debug:
    var:                               kv_name
  when:
    - tier == "bom"

- name:                                "BoM Secrets: Retrieve S User details"  
  block:
    - name:                            "BoM Secrets: Retrieve S User detail secret"
      ansible.builtin.command: >-
        az keyvault secret show
          --vault-name {{ deployer_kv_name }}
          --name "S-Username"
      changed_when:                    false
      register:                        keyvault_secret_show_s_user

    - name:                            "BoM Secrets: Extract S User secret details"
      ansible.builtin.set_fact:
        s_user: >-
          {{ (keyvault_secret_show_s_user.stdout | from_json).value }}
      no_log:                          true

  when:                                
   - s_user is not defined

- name:                                Show S User
  ansible.builtin.debug:
    var:                               s_user
    verbosity:                         2
  when:                                
   - tier == "bom"

- name:                                "BoM Secrets: Retrieve S Password details"  
  block:
    - name:                            "BoM Secrets: Retrieve S Password detail secret"
      ansible.builtin.command: >-
        az keyvault secret show
          --vault-name {{ deployer_kv_name }}
          --name "S-Password"
      changed_when:                    false
      register:                        keyvault_secret_show_s_password
      no_log:                          true
    
    - name:                            "BoM Secrets: Extract S User Password secret details"
      ansible.builtin.set_fact:
        s_password: >-
          {{ (keyvault_secret_show_s_password.stdout | from_json).value }}
      no_log:                          true

  when:
   - s_password is not defined
    


- name:                                Construct SPN Client ID secret name
  ansible.builtin.import_tasks:        "fencing.yaml"
  when:
    - tier == "fencing"

...
# /*---------------------------------------------------------------------------8
# |                                   END                                     |
# +------------------------------------4--------------------------------------*/
