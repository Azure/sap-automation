---
# Set 'oracle' as tuned profile
# Disable SELinux
# Disable core file creation

- name:                                "2.10.2 sap-notes: - Collect facts about installed packages"
  ansible.builtin.package_facts:

- name:                                "2.10.2 sap-notes: - Ensure tuned-profiles-oracle is installed"
  ansible.builtin.dnf:
    name:                              tuned-profiles-oracle.noarch
    state:                             present
  when:                                "'tuned-profiles-oracle.noarch' not in ansible_facts.packages"

- name:                                "2.10.2 sap-notes: - Ensure tuned service is running and enabled"
  ansible.builtin.systemd:
    name:                              tuned
    state:                             started
    enabled:                           true

- name:                                "2.10.2 sap-notes: - Set 'oracle throughput-performance virtual-guest' as tuned profile"
  ansible.builtin.command:             tuned-adm profile oracle throughput-performance virtual-guest
  changed_when:                        false

- name:                                "2.10.2 sap-notes: - Disable core file creation"
  ansible.builtin.lineinfile:
    path:                              /etc/security/limits.d/99-sap.conf
    regexp:                            "@sapsys\\s*{{ item }}\\s*core\\s*0"
    line:                              "@sapsys    {{ item }}    core    0"
    owner:                             root
    group:                             root
    mode:                              0600
    create:                            true
  with_items:
    - soft
    - hard

- name:                                "2.10.2 sap-notes: - Set SELinux as permissive"
  block:
    - name:                            "2.10.1 sap-notes: - Disable SELinux"
      ansible.posix.selinux:
        state:                         permissive
        policy:                        targeted
      register:                        selinux_permissive

    - name:                            "2.10.2 sap-notes: Reboot VMs after selinux is changed"
      ansible.builtin.reboot:
        reboot_timeout:                300
        post_reboot_delay:             60
      ignore_unreachable:              true
      when:
        - selinux_permissive.changed

- name:                                "2.10.2 sap-notes: Check VM Agent Status"
  when:
    - selinux_permissive.changed
  block:
    - name:                            "2.10.2 sap-notes: Clear the failed state of hosts"
      ansible.builtin.meta:            clear_host_errors

    - name:                            "2.10.2 sap-notes: Including Task for VM Agent Actions"
      ansible.builtin.include_tasks:   roles-misc/0.7-VmAgentActions/tasks/main.yaml
      vars:
        subscriptionId:                "{{ subscription_id }}"
        resourceGroup_name:            "{{ resource_group_name }}"
        vmName:                        "{{ vm_name }}"

    - name:                            "2.10.2 sap-notes: Wait for system to become reachable"
      ansible.builtin.wait_for_connection:
        timeout:                       300
      register:                        wait_for_connection_results


...
# /*----------------------------------------------------------------------------8
# |                                    END                                      |
# +-------------------------------------4--------------------------------------*/
