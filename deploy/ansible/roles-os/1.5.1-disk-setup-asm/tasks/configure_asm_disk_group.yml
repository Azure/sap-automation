# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

---
# /*---------------------------------------------------------------------------8
# |                                                                            |
# |           Parameterized ASM Disk Group Configuration                       |
# |                                                                            |
# +------------------------------------4--------------------------------------*/
#
# Purpose: Configure a single ASM disk group with idempotency
#
# Required parameters:
#   - disk_group_name: Name prefix for ASM disks (DATA, ARCH, RECO)
#   - disk_group_list: List of device paths (e.g., ['/dev/sdc', '/dev/sdd'])
#   - disk_group_luns: List of LUN numbers corresponding to disk_group_list
#
# -------------------------------------+---------------------------------------8

- name:                                "1.5.1 Disk Setup - ORACLE ASM - Query existing {{ disk_group_name }} disk configuration"
  ansible.builtin.shell: |
                                       /usr/sbin/oracleasm querydisk "{{ item }}1" 2>&1
  loop:                                "{{ disk_group_list }}"
  register:                            disk_query_results
  failed_when:                         false
  changed_when:                        false

- name:                                "1.5.1 Disk Setup - ORACLE ASM - Build list of un-configured {{ disk_group_name }} disks"
  ansible.builtin.set_fact:
    disks_needing_config:              []
    disk_config_map:                   {}

- name:                                "1.5.1 Disk Setup - ORACLE ASM - Identify un-configured {{ disk_group_name }} disks with LUN mapping"
  when:
                                       - item.rc != 0
                                       - item.stdout is search('is not marked as an ASM disk|is not a known|does not exist or is not instantiated|Unable to access device')
  ansible.builtin.set_fact:
    disks_needing_config:              "{{ disks_needing_config + [item.item] }}"
    disk_config_map:                   "{{ disk_config_map | combine({item.item: disk_group_luns[ansible_loop.index0]}) }}"
  loop:                                "{{ disk_query_results.results }}"
  loop_control:
    extended:                          true

- name:                                "1.5.1 Disk Setup - ORACLE ASM - Debug - {{ disk_group_name }} disks requiring configuration"
  ansible.builtin.debug:
    msg:
      - "Disks to configure:           {{ disks_needing_config }}"
      - "Disk to LUN mapping:          {{ disk_config_map }}"
    verbosity:                         2

- name:                                "1.5.1 Disk Setup - ORACLE ASM - Partition un-configured {{ disk_group_name }} disks"
  become:                              true
  become_user:                         root
  when:                                disks_needing_config | length > 0
  community.general.parted:
    device:                            "{{ item }}"
    number:                            1
    state:                             present
    label:                             msdos
    part_type:                         primary
    part_start:                        0%
    part_end:                          100%
  loop:                                "{{ disks_needing_config }}"

- name:                                "1.5.1 Disk Setup - ORACLE ASM - Initialize {{ disk_group_name }} ASM disks with stable naming"
  when:                                disks_needing_config | length > 0
  ansible.builtin.shell: |
                                       lun_num="{{ disk_config_map[item] }}"
                                       disk_name="{{ disk_group_name }}{{ db_sid | upper }}$(printf '%02d' ${lun_num})"
                                       /usr/sbin/oracleasm createdisk "${disk_name}" "{{ item }}1"
  loop:                                "{{ disks_needing_config }}"
  register:                            disk_creation_results

- name:                                "1.5.1 Disk Setup - ORACLE ASM - Set permissions on all {{ disk_group_name }} disk partitions"
  become:                              true
  become_user:                         root
  when:                                disk_group_list | length > 0
  ansible.builtin.file:
    path:                              "{{ item }}1"
    owner:                             "{{ grid_user_name }}"
    group:                             oinstall
    mode:                              '0660'
  loop:                                "{{ disk_group_list }}"

- name:                                "1.5.1 Disk Setup - ORACLE ASM - Report {{ disk_group_name }} disk group configuration status"
  ansible.builtin.debug:
    msg:
      - "Total {{ disk_group_name }} disks: {{ disk_group_list | length }}"
      - "Disks newly configured: {{ disks_needing_config | length }}"
      - "Disks already configured: {{ (disk_group_list | length) - (disks_needing_config | length) }}"
