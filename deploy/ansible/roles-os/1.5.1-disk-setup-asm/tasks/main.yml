# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

---

# /*---------------------------------------------------------------------------8
# |                                                                            |
# |                         OS Base Disk Configuration                         |
# |                                                                            |
# +------------------------------------4--------------------------------------*/

- name:                                "1.5.1 Disk Setup - ORACLE ASM - Load the disk configuration settings"
  ansible.builtin.include_vars:        disks_config_asm.yml

- name:                                "1.5.1 Disk Setup - ORACLE ASM - Set the NFS Server name list"
  ansible.builtin.set_fact:
    nfs_server_temp:                   "{{ nfs_server_temp | default([]) + [item] }}"
  with_items:
                                       - "{{ query('inventory_hostnames', '{{ sap_sid | upper }}_SCS') }}"
                                       - "{{ query('inventory_hostnames', '{{ sap_sid | upper }}_DB') }}"

# CREATE VOLUME GROUPS BASED ON sap-parameters.yaml
# -------------------------------------+---------------------------------------8
#
- name:                                "1.5.1 Disk Setup - ORACLE ASM - Volume Group creation"
  when:
                                       - tier == "ora"
                                       - node_tier == "oracle-asm"
  community.general.lvg:
    vg:                                "{{ item.vg }}"
    pvs:                               "{{ item.pvs }}"
    pesize:                            4M
    state:                             present
  loop:                                "{{ volume_groups }}"
  register:                            vgscreated

- name:                                "1.5.1 Disk Setup - ORACLE ASM - Filter the vg name from vgscreated results"
  ansible.builtin.set_fact:
    vgcreatedlist:                     "{{ vgscreated | json_query('results[*].item.vg') }}" # noqa: jinja[invalid]

- name:                                "1.5.1 Disk Setup - ORACLE ASM - Print vgcreated details"
  ansible.builtin.debug:
    var:
                                       - vgcreatedlist
                                       - logical_volumes
                                       - vgscreated.results
    verbosity:                         2

# CREATE LOGICAL VOLUMES BASED ON VGCREATEDLIST
# -------------------------------------+---------------------------------------8
#
- name:                                "1.5.1 Disk Setup - ORACLE ASM - Logical Volume creation"
  when:
                                       - tier == "ora"
                                       - item.node_tier == "oracle-asm"
                                       - item.vg in vgcreatedlist
  community.general.lvol:
    lv:                                "{{ item.lv }}"
    vg:                                "{{ item.vg }}"
    size:                              "{{ item.size }}"
    opts:                              "{{ lvol_opts_from_lv_item }}"
    active:                            true
    state:                             present
    shrink:                            false
    resizefs:                          false
  loop:                                "{{ logical_volumes }}"
  register:                            lvscreated

- name:                                "1.5.1 Disk Setup - ORACLE ASM - Print lvscreated details"
  ansible.builtin.debug:
    var:                               lvscreated
    verbosity:                         2

- name:                                "1.5.1 Disk Setup - ORACLE ASM - Filter the logical volumes created results"
  ansible.builtin.set_fact:
    lvcreatedlist_tmp:                 "{{ lvscreated.results | rejectattr('skipped', 'defined') | list }}"

- name:                                "1.5.1 Disk Setup - ORACLE ASM - Print vgcreated filtered details"
  ansible.builtin.debug:
    var:                               lvcreatedlist_tmp
    verbosity:                         2

- name:                                "1.5.1 Disk Setup - ORACLE ASM - Filter the logical volumes created results1"
  ansible.builtin.set_fact:
    lvcreatedlist:                     "{{ lvcreatedlist_tmp | map(attribute='item.lv') | list }}"

- name:                                "1.5.1 Disk Setup - ORACLE ASM - Print vgcreated details"
  ansible.builtin.debug:
    var:                               lvcreatedlist
    verbosity:                         2

- name:                                "1.5.1 Disk Setup - ORACLE ASM - Filesystem creation"
  when:
                                       - item.tier in ["all", tier ]
                                       - item.node_tier in ["all", node_tier]
                                       - item.fstype is defined
                                       - item.lv in lvcreatedlist
  community.general.filesystem:
    dev:                               "{{ dev_path_from_lv_item }}"
    fstype:                            "{{ item.fstype }}"
    opts:                              "{{ item.fsopts | default('') }}"
  loop:                                "{{ logical_volumes }}"
  register :                           filesystemscreated

- name:                                "1.5.1 Disk Setup - ORACLE ASM - Print values to be passed for filesystem creation"
  ansible.builtin.debug:
    var:                               filesystemscreated
    verbosity:                         2

# /*---------------------------------------------------------------------------8
# |                                                                            |
# |                         ASM Specific Configuration                         |
# |                                                                            |
# +------------------------------------4--------------------------------------*/

# Create directories
- name:                                "1.5.1 Disk Setup - ORACLE ASM - Create run flag directory"
  ansible.builtin.file:
    path:                              /etc/sap_deployment_automation
    state:                             directory
    mode:                              0755

- name:                                "1.5.1 Disk Setup - ORACLE ASM - Create asm flag directory"
  ansible.builtin.file:
    path:                              /etc/sap_deployment_automation/asm
    state:                             directory
    mode:                              0755

- name:                                "1.5.1 Disk Setup - ORACLE ASM - Make oracle:oinstall as owners of /oracle"
  ansible.builtin.file:
    path:                              /oracle
    state:                             directory
    mode:                              0755
    owner:                             oracle
    group:                             oinstall

- name:                                "1.5.1 Disk Setup - ORACLE ASM - Set permissions on target_media_location"
  ansible.builtin.file:
    path:                              "{{ target_media_location }}"
    state:                             directory
    mode:                              0777

# /*---------------------------------------------------------------------------8
# |  ONE-TIME SETUP: Packages and Oracle ASM Configuration                     |
# +----------------------------------------------------------------------------*/

- name:                                "1.5.1 Disk Setup - ORACLE ASM - Check if Oracle ASM is configured"
  ansible.builtin.shell: |
                                       set -o pipefail
                                       /usr/sbin/oracleasm configure 2>&1 | grep -q "{{ grid_user_name }}"
  register:                            oracleasm_check
  failed_when:                         false
  changed_when:                        false

- name:                                "1.5.1 Disk Setup - ORACLE ASM - One-time package installation and configuration"
  when:                                oracleasm_check.rc != 0
  block:

    - name:                            "1.5.1 Disk Setup - ORACLE ASM - Install libbpf package"
      ansible.builtin.dnf:
        name:
                                       - "{{ target_media_location }}/RPM/libbpf-0.6.0-6.el8.x86_64.rpm"
        state:                         present
        disable_gpg_check:             true

    - name:                            "1.5.1 Disk Setup - ORACLE ASM - Check for v2 RPMs"
      ansible.builtin.stat:
        path:                          "{{ target_media_location }}/downloads/oracleasmlib-2.0.17-1.el8.x86_64.rpm"
      register:                        oracle_asm_v2

    - name:                            "1.5.1 Disk Setup - ORACLE ASM - Install RPM Packages v2"
      when:                            oracle_asm_v2.stat.exists
      ansible.builtin.dnf:
        name:
                                       - "{{ target_media_location }}/downloads/oracleasmlib-2.0.17-1.el8.x86_64.rpm"
                                       - "{{ target_media_location }}/downloads/oracleasm-support-2.1.12-1.el8.x86_64.rpm"
        state:                         present
        disable_gpg_check:             true

    - name:                            "1.5.1 Disk Setup - ORACLE ASM - Install compat packages for RHEL7/OL7"
      when:                            distribution_id in ['redhat7', 'oraclelinux7']
      ansible.builtin.dnf:
        name:
                                       - "{{ target_media_location }}/downloads/compat-libcap1-1.10-7.el7.x86_64.rpm"
                                       - "{{ target_media_location }}/downloads/compat-libstdc++-33-3.2.3-72.el7.x86_64.rpm"
        state:                         present
        disable_gpg_check:             true

    - name:                            "1.5.1 Disk Setup - ORACLE ASM - Check for el8 RPMs"
      ansible.builtin.stat:
        path:                          "{{ target_media_location }}/RPM/oracleasmlib-3.0.0-13.el8.x86_64.rpm"
      register:                        oracle_asm_v3

    - name:                            "1.5.1 Disk Setup - ORACLE ASM - Install RPM Packages el8"
      when:                            oracle_asm_v3.stat.exists
      ansible.builtin.dnf:
        name:
                                       - "{{ target_media_location }}/RPM/oracleasmlib-3.0.0-13.el8.x86_64.rpm"
                                       - "{{ target_media_location }}/RPM/oracleasm-support-3.0.0-6.el8.x86_64.rpm"
        state:                         present
        disable_gpg_check:             true

    - name:                            "1.5.1 Disk Setup - ORACLE ASM - Check for el9 RPMs"
      ansible.builtin.stat:
        path:                          "{{ target_media_location }}/RPM/oracleasmlib-3.1.1-1.el9.x86_64.rpm"
      register:                        oracle_asm_v3

    - name:                            "1.5.1 Disk Setup - ORACLE ASM - Install RPM Packages el9"
      when:                            oracle_asm_v3.stat.exists
      ansible.builtin.dnf:
        name:
                                       - "{{ target_media_location }}/RPM/oracleasmlib-3.1.1-1.el9.x86_64.rpm"
                                       - "{{ target_media_location }}/RPM/oracleasm-support-3.1.1-4.el9.x86_64.rpm"
        state:                         present
        disable_gpg_check:             true

    - name:                            "1.5.1 Disk Setup - ORACLE ASM - Configure Oracle ASM"
      ansible.builtin.shell: |
                                       set -o errexit
                                       /usr/sbin/oracleasm configure -u {{ grid_user_name }} -g oinstall -e -s y
                                       /usr/sbin/oracleasm init
      register:                        oracle_asm_config_results
      failed_when:                     oracle_asm_config_results.rc not in [0, 1]

    - name:                            "1.5.1 Disk Setup - ORACLE ASM - Start and enable oracleasm service"
      ansible.builtin.systemd:
        name:                          oracleasm
        state:                         restarted
        enabled:                       true

# /*---------------------------------------------------------------------------8
# |  DISK DISCOVERY: Build disk lists for each disk group                      |
# +----------------------------------------------------------------------------*/

- name:                                "1.5.1 Disk Setup - ORACLE ASM - Set current host for disk filtering"
  ansible.builtin.set_fact:
    current_host:                      "{{ ansible_hostname }}"

- name:                                "1.5.1 Disk Setup - ORACLE ASM - Capture disks for DATA Group"
  when:
                                       - item.type == "data-asm"
                                       - item.host == current_host
  ansible.builtin.shell: |
                                       set -o errexit
                                       readlink -f lun{{ item.LUN }}
  loop:                                "{{ disks }}"
  register:                            data_group
  args:
    chdir:                             "/dev/disk/azure/scsi1"

- name:                                "1.5.1 Disk Setup - ORACLE ASM - Build DATA disk list with LUN metadata"
  ansible.builtin.set_fact:
    data_disk_list:                    "{{ data_group.results | rejectattr('skipped', 'defined') | map(attribute='stdout') | list }}"
    data_disk_luns:                    "{{ data_group.results | rejectattr('skipped', 'defined') | map(attribute='item.LUN') | list }}"

- name:                                "1.5.1 Disk Setup - ORACLE ASM - Capture disks for ARCH Group"
  when:
                                       - item.type == "arch-asm"
                                       - item.host == current_host
  ansible.builtin.shell: |
                                       set -o errexit
                                       readlink -f lun{{ item.LUN }}
  loop:                                "{{ disks }}"
  register:                            archive_group
  args:
    chdir:                             "/dev/disk/azure/scsi1"

- name:                                "1.5.1 Disk Setup - ORACLE ASM - Build ARCH disk list with LUN metadata"
  ansible.builtin.set_fact:
    archive_disk_list:                 "{{ archive_group.results | rejectattr('skipped', 'defined') | map(attribute='stdout') | list }}"
    archive_disk_luns:                 "{{ archive_group.results | rejectattr('skipped', 'defined') | map(attribute='item.LUN') | list }}"

- name:                                "1.5.1 Disk Setup - ORACLE ASM - Capture disks for RECO Group"
  when:
                                       - item.type == "reco-asm"
                                       - item.host == current_host
  ansible.builtin.shell: |
                                       set -o errexit
                                       readlink -f lun{{ item.LUN }}
  loop:                                "{{ disks }}"
  register:                            recovery_group
  args:
    chdir:                             "/dev/disk/azure/scsi1"

- name:                                "1.5.1 Disk Setup - ORACLE ASM - Build RECO disk list with LUN metadata"
  ansible.builtin.set_fact:
    recovery_disk_list:                "{{ recovery_group.results | rejectattr('skipped', 'defined') | map(attribute='stdout') | list }}"
    recovery_disk_luns:                "{{ recovery_group.results | rejectattr('skipped', 'defined') | map(attribute='item.LUN') | list }}"

- name:                                "1.5.1 Disk Setup - ORACLE ASM - Print disk information"
  ansible.builtin.debug:
    msg:
      - "Data Disks:    {{ data_disk_list }}"
      - "Data LUNs:     {{ data_disk_luns }}"
      - "Archive Disks: {{ archive_disk_list }}"
      - "Archive LUNs:  {{ archive_disk_luns }}"
      - "Recovery Disks:{{ recovery_disk_list }}"
      - "Recovery LUNs: {{ recovery_disk_luns }}"
    verbosity:                         2

# /*---------------------------------------------------------------------------8
# |  DISK GROUP CONFIGURATION: Idempotent disk initialization                  |
# +----------------------------------------------------------------------------*/

- name:                                "1.5.1 Disk Setup - ORACLE ASM - Configure DATA disk group"
  ansible.builtin.include_tasks:       configure_asm_disk_group.yml
  vars:
    disk_group_name:                   "DATA"
    disk_group_list:                   "{{ data_disk_list }}"
    disk_group_luns:                   "{{ data_disk_luns }}"

- name:                                "1.5.1 Disk Setup - ORACLE ASM - Configure ARCH disk group"
  ansible.builtin.include_tasks:       configure_asm_disk_group.yml
  vars:
    disk_group_name:                   "ARCH"
    disk_group_list:                   "{{ archive_disk_list }}"
    disk_group_luns:                   "{{ archive_disk_luns }}"

- name:                                "1.5.1 Disk Setup - ORACLE ASM - Configure RECO disk group"
  ansible.builtin.include_tasks:       configure_asm_disk_group.yml
  vars:
    disk_group_name:                   "RECO"
    disk_group_list:                   "{{ recovery_disk_list }}"
    disk_group_luns:                   "{{ recovery_disk_luns }}"
