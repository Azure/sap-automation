# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

# Returns bom object
- name:                                "1.3.3 Repositories from BOM -  Register BoM"
  ansible.builtin.include_role:
    name:                              roles-sap/3.3.1-bom-utility
    tasks_from:                        bom-register
  vars:
    bom_name:                          "{{ bom_base_name }}"
    task_prefix:                       "BOM based repositories: "
    sa_enabled:                        true
  when:
                                       - bom is undefined

- name:                                "1.3.3 Repositories from BOM - Add the repositories"
  when:
                                       - bom is defined
                                       - item.url is defined
                                       - ( item.type is defined          and (item.type | lower) == 'rpm' )
                                       - ( item.archive is defined       and (item.archive | trim | length) > 0 )
                                       - ( item.distributions is defined and (distribution_id in item.distributions) )
  become:                              true
  become_user:                         root
  ansible.builtin.yum_repository:
    name:                              "{{ target_media_location }}/RPM/{{ item.archive }}"
    state:                             "present"
    gpgcheck:                          false
    baseurl:                           "{{ item.url }}"
  loop:                                "{{ bom.materials.media | flatten(levels=1) }}"

- name:                                "1.3.3 Repositories from BOM - Add the repositories"
  when:
                                       - bom is defined
                                       - item.url is undefined
                                       - ( item.type is defined          and (item.type | lower) == 'rpm' )
                                       - ( item.archive is defined       and (item.archive | trim | length) > 0 )
                                       - ( item.distributions is defined and (distribution_id in item.distributions) )
  become:                              true
  become_user:                         root
  ansible.builtin.dnf:
    name:                              "{{ target_media_location }}/RPM/{{ item.archive }}"
    state:                             "present"
    disable_gpg_check:                 true
  loop:                                "{{ bom.materials.media | flatten(levels=1) }}"
