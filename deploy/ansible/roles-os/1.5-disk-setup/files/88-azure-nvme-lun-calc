#!/bin/bash
# Azure NVMe LUN calculator
# Direct hardware attribute approach
#
# Usage: azure-nvme-lun-calc <device_name> <nsid>
#
# Parameters:
# $1 - Device name (e.g., nvme0n2)
# $2 - Namespace ID (NSID) from hardware attribute

DEVICE_NAME="$1"
NSID="$2"

# Validate input parameters
if [ -z "$DEVICE_NAME" ]; then
    echo "ERROR: Device name is required" >&2
    exit 1
fi

if [ -z "$NSID" ] || [ "$NSID" -lt 1 ] 2>/dev/null; then
    echo "ERROR: Valid NSID is required (got: '$NSID')" >&2
    exit 1
fi

# Azure NVMe namespace mapping: NSID 1 = OS disk, NSID 2+ = data disks
# LUN ID = NSID - 2 (first data disk NSID 2 maps to LUN 0)
LUN_ID=$((NSID - 2))

# Ensure LUN ID is not negative (for OS disk or invalid cases)
if [ "$LUN_ID" -ge 0 ]; then
    echo "$LUN_ID"
else
    # OS disk (NSID 1) or invalid case - don't create data disk symlink
    exit 1
fi
