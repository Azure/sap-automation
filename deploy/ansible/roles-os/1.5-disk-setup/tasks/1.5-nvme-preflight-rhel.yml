# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

# /*---------------------------------------------------------------------------8
# |                                                                            |
# |              NVMe Support for Azure VMs - RHEL Specific Tasks              |
# |                                                                            |
# +------------------------------------4--------------------------------------*/
---
# -------------------------------------+---------------------------------------8
#
# Task: 1.5.4 - NVMe Support - RHEL Specific Tasks
#
# -------------------------------------+---------------------------------------8

# RHEL version and distribution validation
- name:                                "1.5.4 NVMe Support (RHEL) - Validate RHEL distribution and version"
  ansible.builtin.assert:
    that:
      - ansible_distribution == 'RedHat'
      - ansible_distribution_version is version('8.6', '>=')
    fail_msg:                          "RHEL version must be 8.6 or higher for NVMe support. Current: {{ ansible_distribution }} {{ ansible_distribution_version }}"
    success_msg:                       "RHEL version {{ ansible_distribution_version }} is supported for NVMe"

# Set RHEL-specific facts
- name:                                "1.5.4 NVMe Support (RHEL) - Set RHEL-specific facts"
  ansible.builtin.set_fact:
    rhel_major_version:                "{{ ansible_distribution_major_version }}"
    azure_nvme_utils_supported:        "{{ ansible_distribution_version is version('9.0', '>=') }}"
    grub_config_file:                  "{{ '/boot/efi/EFI/redhat/grub.cfg' if is_uefi_system else '/boot/grub2/grub.cfg' }}"
    grub_cmdline_param:                "GRUB_CMDLINE_LINUX"

# Configure Azure NVME Utils repository and package for RHEL
- name:                                "1.5.4 NVMe Support (RHEL) - Configure Azure NVME Utils repository"
  when:                                azure_nvme_utils_supported
  block:
    - name:                            "1.5.4 NVMe Support (RHEL) - Add Azure NVME Utils repository"
      ansible.builtin.yum_repository:
        name:                          azure_nvme_utils
        description:                   "Copr repo for azure-nvme-utils owned by cjp256"
        baseurl:                       "https://download.copr.fedorainfracloud.org/results/cjp256/azure-nvme-utils/rhel-{{ rhel_major_version }}-x86_64/"
        gpgcheck:                      true
        gpgkey:                        "https://download.copr.fedorainfracloud.org/results/cjp256/azure-nvme-utils/pubkey.gpg"
        enabled:                       true
        state:                         present
      register:                        repo_added

    - name:                            "1.5.4 NVMe Support (RHEL) - Refresh repository cache"
      when:                            repo_added.changed
      ansible.builtin.shell:           dnf makecache
      changed_when:                    false

    - name:                            "1.5.4 NVMe Support (RHEL) - Install Azure NVME Utils package"
      ansible.builtin.package:
        name:                          azure-nvme-utils
        state:                         present
      register:                        nvme_utils_installed

    - name:                            "1.5.4 NVMe Support (RHEL) - Install Azure NVME cli package"
      ansible.builtin.package:
        name:                          nvme-cli
        state:                         present
      register:                        nvme_utils_installed

# Check if all required NVMe modules are loaded in initramfs
- name:                                "1.5.4 NVMe Support (RHEL) - Check basic NVMe modules in initramfs"
  ansible.builtin.shell: |
                                       set -o pipefail
                                       lsinitrd /boot/initramfs-$(uname -r).img | grep nvme
  register:                            initramfs_nvme_basic_check
  failed_when:                         false
  changed_when:                        false

- name:                                "1.5.4 NVMe Support (RHEL) - Check for all required NVMe modules in initramfs"
  ansible.builtin.shell: |
                                       set -o pipefail
                                       MISSING=0
                                       REQUIRED_MODULES="nvme nvme-core nvme-fabrics nvme-fc nvme-rdma nvme-loop nvmet nvmet-fc nvme-tcp"
                                       MISSING_MODULES=""
                                       for MODULE in $REQUIRED_MODULES; do
                                         if ! lsinitrd /boot/initramfs-$(uname -r).img | grep -q "$MODULE"; then
                                           MISSING_MODULES="$MISSING_MODULES $MODULE"
                                           MISSING=1
                                         fi
                                       done
                                       if [ $MISSING -eq 1 ]; then
                                         echo "$MISSING_MODULES"
                                       fi
                                       exit $MISSING
  register:                            nvme_module_complete_check
  failed_when:                         false
  changed_when:                        false

# Set RHEL-specific initramfs status facts
- name:                                "1.5.4 NVMe Support (RHEL) - Set initramfs status facts"
  ansible.builtin.set_fact:
    nvme_in_initramfs:                 "{{ initramfs_nvme_basic_check.rc == 0 }}"
    nvme_modules_complete:             "{{ nvme_module_complete_check.rc == 0 }}"
    missing_nvme_modules:              "{{ nvme_module_complete_check.stdout | trim if nvme_module_complete_check.rc != 0 else '' }}"

- name:                                "1.5.4 NVMe Support (RHEL) - Display missing NVMe modules"
  when:                                not nvme_modules_complete
  ansible.builtin.debug:
    msg:                               "Missing NVMe modules in RHEL initramfs: {{ missing_nvme_modules }}"

# Configure dracut for NVMe support
- name:                                "1.5.4 NVMe Support (RHEL) - Create dracut.conf.d directory"
  when:                                not nvme_modules_complete
  ansible.builtin.file:
    path:                              /etc/dracut.conf.d
    state:                             directory
    mode:                              '0755'
    owner:                             root
    group:                             root

- name:                                "1.5.4 NVMe Support (RHEL) - Add NVMe drivers to dracut configuration"
  ansible.builtin.copy:
    src:                               88-nvme-dracut.conf
    dest:                              /etc/dracut.conf.d/nvme.conf
    mode:                              '0644'
    owner:                             root
    group:                             root
    force:                             true
  register:                            dracut_conf_added

# Configure GRUB with NVMe timeout parameters for RHEL
- name:                                "1.5.4 NVMe Support (RHEL) - Check if GRUB has NVMe timeout parameters"
  ansible.builtin.shell: |
                                       set -o pipefail
                                       grep "{{ grub_cmdline_param }}.*nvme_core.io_timeout=240" /etc/default/grub || true
  register:                            grub_nvme_timeout_check
  changed_when:                        false
  failed_when:                         false

- name:                                "1.5.4 NVMe Support (RHEL) - Get current GRUB configuration"
  ansible.builtin.shell: |
                                       set -o pipefail
                                       grep "{{ grub_cmdline_param }}" /etc/default/grub || echo "No {{ grub_cmdline_param }} found"
  register:                            current_grub_config
  changed_when:                        false
  failed_when:                         false

- name:                                "1.5.4 NVMe Support (RHEL) - Show current GRUB configuration"
  ansible.builtin.debug:
    msg:                               "Current GRUB configuration: {{ current_grub_config.stdout }}"
    verbosity:                         1

- name:                                "1.5.4 NVMe Support (RHEL) - Add NVMe timeout parameters to GRUB"
  when:
    - grub_nvme_timeout_check.rc != 0
    - '"nvme_core.io_timeout=240" not in current_grub_config.stdout'
  ansible.builtin.replace:
    path:                              /etc/default/grub
    regexp:                            '^({{ grub_cmdline_param }}=")([^"]*)(")$'
    replace:                           '\1\2 nvme_core.io_timeout=240 nvme_core.admin_timeout=240\3'
  register:                            grub_updated

- name:                                "1.5.4 NVMe Support (RHEL) - Update GRUB configuration file"
  when:
    - grub_updated is defined
    - grub_updated.changed
  ansible.builtin.command:             grub2-mkconfig -o {{ grub_config_file }}
  register:                            grub_config_updated
  changed_when:                        true

- name:                                "1.5.4 NVMe Support (RHEL) - Verify GRUB configuration update"
  when:
    - grub_updated is defined
    - grub_updated.changed
  ansible.builtin.shell: |
                                       set -o pipefail
                                       grep "nvme_core.io_timeout=240" /etc/default/grub
  register:                            grub_verify
  changed_when:                        false
  failed_when:                         false

- name:                                "1.5.4 NVMe Support (RHEL) - Report GRUB configuration status"
  when:
    - grub_updated is defined
    - grub_updated.changed
  ansible.builtin.debug:
    msg:                               "{{ 'GRUB NVMe timeout parameters successfully configured on RHEL' if grub_verify.rc == 0 else 'WARNING: Failed to configure GRUB NVMe timeout parameters on RHEL' }}"

# Rebuild initramfs if needed
- name:                                "1.5.4 NVMe Support (RHEL) - Rebuild initramfs with dracut"
  when:                                dracut_conf_added.changed
  ansible.builtin.command:             dracut -f -v
  register:                            initramfs_rebuilt

# Install udev rules for Azure NVMe disks
- name:                                "1.5.4 NVMe Support (RHEL) - Create Azure NVMe LUN calculation helper script"
  ansible.builtin.copy:
    dest:                              /usr/local/bin/azure-nvme-lun-calc
    mode:                              '0755'
    owner:                             root
    group:                             root
    content: |
      #!/bin/bash
      # Azure NVMe LUN calculator
      # Takes namespace ID and returns LUN ID (NSID - 2)
      echo $(($1 - 2))
  register:                            helper_script_created

- name:                                "1.5.4 NVMe Support (RHEL) - Install udev rules for Azure NVMe disks"
  ansible.builtin.copy:
    src:                               88-azure-nvme-data-disk.rules
    dest:                              /usr/lib/udev/rules.d/88-azure-data-disk.rules
    owner:                             root
    group:                             root
    force:                             true
    mode:                              '0644'
  register:                            udev_rules_added

- name:                                "1.5.4 NVMe Support (RHEL) - Reload udev rules"
  when:                                udev_rules_added.changed
  ansible.builtin.command:             udevadm control --reload-rules
  register:                            udev_rules_reloaded

- name:                                "1.5.4 NVMe Support (RHEL) - Trigger udev rules for existing devices"
  when:                                udev_rules_added.changed
  ansible.builtin.command:             udevadm trigger
  register:                            udev_triggered

- name:                                "1.5.4 NVMe Support (RHEL) - Verify udev rules are applied"
  when:                                udev_rules_added.changed
  ansible.builtin.shell: |
                                       set -o pipefail
                                       udevadm info --name=/dev/sda | grep -E "SYMLINK.*disk/azure|DEVLINKS.*disk/azure" || echo "No Azure symlinks found"
  register:                            udev_verification
  failed_when:                         false
  changed_when:                        false

- name:                                "1.5.4 NVMe Support (RHEL) - Display udev verification results"
  when:
    - udev_rules_added.changed
    - udev_verification is defined
    - udev_verification.stdout is defined
  ansible.builtin.debug:
    msg:                               "Udev configuration verification on RHEL: {{ 'Successful - Azure disk symlinks detected' if 'disk/azure' in udev_verification.stdout else 'Note: No Azure disk symlinks detected (normal for systems without data disks)' }}"
    verbosity:                         1

- name:                                "1.5.4 NVMe Support (RHEL) - Set final RHEL configuration facts"
  ansible.builtin.set_fact:
    nvme_rhel_configured:              true
    nvme_udev_rules_installed:         "{{ udev_rules_added.changed | default(false) }}"
