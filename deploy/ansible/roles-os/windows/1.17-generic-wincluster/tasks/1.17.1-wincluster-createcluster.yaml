---
# This user must have the permission to create the CNO (Cluster Name Object)
# in Active Directory. This need not be a domain admin account.
- name: "Check the node status"
  win_shell: |
    $cluster = Get-Cluster -Name {{ cluster_name }} -ErrorAction SilentlyContinue
    if($cluster){
        (Get-ClusterNode -Cluster $cluster -Name {{ ansible_hostname }}).NodeName -join ','
        #foreach($node in (Get-ClusterNode -Cluster $cluster)){
        #    $node.NodeName
        #    $node.State
        #}
    }
    Get-ClusterNode -Name {{ ansible_hostname }} | Select-Object -ExpandProperty State
  register: cluster_node_names
  ignore_errors: yes
  changed_when: false

- name: "Create the cluster"
  win_dsc:
    resource_name: xCluster
    Name: "{{ cluster_name }}"
    StaticIPAddress: "{{ cluster_ip_address }}"
    DomainAdministratorCredential_username: "{{ domain_service_account }}@{{ domain }}"
    DomainAdministratorCredential_password: "{{ domain_service_password }}"
  when:
    - ansible_hostname == primary_node
    - cluster_node_names.stdout | length == 0
  register: cluster_creation
  vars:
    ansible_become:                     true
    ansible_become_method:              runas

- name: "Wait for cluster to start up and stabilize"
  win_dsc:
    resource_name: xWaitForCluster
    Name: "{{ cluster_name }}"
    RetryIntervalSec: 10
    RetryCount: 60
  when:
    - ansible_hostname == primary_node
    - cluster_creation is changed

- name: "Configure cluster quorum"
- name: "Add Additional Failover Cluster Nodes Windows Server 2016"
- name: "Add Additional Failover Cluster Nodes Windows Server 2019"
- name: "Ensure the cluster is healthy"

...
