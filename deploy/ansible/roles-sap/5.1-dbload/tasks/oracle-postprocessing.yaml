# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

- name:                                "5.1. Database Load - ORACLE - Create directories"
  ansible.builtin.file:
    path:                              "{{ item.path }}"
    state:                             directory
    mode:                              '{{ item.mode }}'
    owner:                             "{{ oracle_user_name }}"
    group:                             oinstall
  loop:
    - { mode: '0755', path: '/etc/sap_deployment_automation/oracle' }
    - { mode: '0755', path: '/etc/sap_deployment_automation/{{ sid_to_be_deployed.sid | upper }}' }

- name:                                "5.1. Database Load - ORACLE: Set Runtime Variables"
  ansible.builtin.set_fact:
    is_UEK6:                           "{{ ansible_kernel is version('5.5', '<') }}"
    CV_ASSUME_DISTID:                  "{% if ansible_kernel is version('5.5', '<') %} OEL7 {% else %} OL8 {% endif %}"

- name:                                "5.1. Database Load - ORACLE - Ensure Oracle is running"
  become:                              true
  become_user:                         "{{ oracle_user_name }}"
  ansible.builtin.shell: |
                                       setenv ORACLE_SID {{ db_sid | upper }}
                                       $ORACLE_HOME/bin/sqlplus -S / as sysdba <<EOF
                                       ALTER DATABASE OPEN;
                                       EXIT;
                                       EOF
  register:                            dbstarted_results
  failed_when:                         false
  args:
    executable:                        /bin/csh


# Step 17
- name:                                "5.1. Database Load - ORACLE: Show Status message"
  ansible.builtin.debug:
    msg:                               "5.1. Database Load - ORACLE: Run the post-installation script catsbp"

- name:                                "5.1. Database Load - ORACLE: Check if catsbp exists"
  ansible.builtin.stat:
    path:                               "/oracle/{{ db_sid | upper }}/{{ ora_version }}/sapbundle/catsbp"
  register:                            catsbp_stat

- name:                                "5.1. Database Load - ORACLE: Run run the post-installation script catsbp"
  when:                                catsbp_stat.stat.exists
  block:
    - name:                            "5.1. Database Load - ORACLE: Run run the post-installation script catsbp"
      become:                          true
      become_user:                     "{{ oracle_user_name }}"
      ansible.builtin.shell: |
                                       setenv ORACLE_SID {{ db_sid | upper }}
                                       setenv ORACLE_HOME /oracle/{{ db_sid | upper }}/{{ ora_release }}
                                       $ORACLE_HOME/sapbundle/catsbp

      register:                        catsbp_results
      environment:
        CV_ASSUME_DISTID:              "{{ CV_ASSUME_DISTID }}"
        ORACLE_SID:                    "{{ db_sid | upper }}"
      args:
        executable:                    /bin/csh

    - name:                            "5.1. Database Load - ORACLE: Debug: GRID prepatch output"
      ansible.builtin.copy:
        dest:                          "/etc/sap_deployment_automation/oracle/catsbp.log"
        content:                       "{{ catsbp_results.stdout }}"
        mode:                          0777
      when:                            catsbp_results.stdout is defined

  rescue:

    - name:                            "5.1. Database Load - ORACLE - Ensure Oracle is running"
      become:                          true
      become_user:                     "{{ oracle_user_name }}"
      ansible.builtin.shell: |
                                       setenv ORACLE_SID {{ db_sid | upper }}
                                       $ORACLE_HOME/bin/sqlplus -S / as sysdba <<EOF
                                       SHUTDOWN IMMEDIATE;
                                       STARTUP MOUNT;
                                       ALTER DATABASE OPEN;
                                       EXIT;
                                       EOF
      register:                        dbstarted_results
      failed_when:                     false
      args:
        executable:                    /bin/csh

    - name:                            "5.1. Database Load - ORACLE: Run run the post-installation script catsbp"
      become:                          true
      become_user:                     "{{ oracle_user_name }}"
      ansible.builtin.shell: |
                                       setenv ORACLE_SID {{ db_sid | upper }}
                                       setenv ORACLE_HOME /oracle/{{ db_sid | upper }}/{{ ora_release }}
                                       $ORACLE_HOME/sapbundle/catsbp

      register:                        catsbp_results
      environment:
        CV_ASSUME_DISTID:              "{{ CV_ASSUME_DISTID }}"
        ORACLE_SID:                    "{{ db_sid | upper }}"
      args:
        executable:                    /bin/csh

    - name:                            "5.1. Database Load - ORACLE: Debug: GRID prepatch output"
      ansible.builtin.copy:
        dest:                          "/etc/sap_deployment_automation/oracle/catsbp.log"
        content:                       "{{ catsbp_results.stdout }}"
        mode:                          0777
      when:                            catsbp_results.stdout is defined

- name:                                "5.1. Database Load - ORACLE: Set Variables"
  ansible.builtin.set_fact:
    PAS:                               'pas'
    pga_temp_l4tb_std:                 "{{ ((ansible_memory_mb.real.total * 0.60 ) * 0.2) | round | int }}"
    pga_temp_l4tb_dis:                 "{{ ((ansible_memory_mb.real.total * 0.80 ) * 0.2) | round | int }}"
    # pga_temp_g4tb:                       "{{ ((ansible_memory_mb.real.total*0.85)*0.2) |round |int }}"

# PGA & SGA for RAM < 4TB
- name:                                "5.1. Database Load - ORACLE: Set the SGA and PGA Sizes for RAM < 4TB"
  ansible.builtin.set_fact:
    main_mem1:                         "{{ ansible_memory_mb.real.total }}"
    ora_sga:                           "{{ (ansible_memory_mb.real.total * 0.60) | round | int }}"
    ora_pga:                           "{{ [(pga_temp_l4tb_std | int), 4194304] | min }}"

  when:
    - ansible_memory_mb.real.total < 4194304
    - "'pas' not in supported_tiers"
- name:                                "5.1. Database Load - ORACLE: Set the SGA and PGA Sizes for RAM < 4TB Single Node Deployments"
  ansible.builtin.set_fact:
    main_mem1:                         "{{ ansible_memory_mb.real.total }}"
    ora_sga:                           "{{ (ansible_memory_mb.real.total * 0.75) | round | int }}"
    ora_pga:                           "{{ [(pga_temp_l4tb_std | int), 4194304] | min }}"
  when:
    - ansible_memory_mb.real.total < 4194304
    - "'pas' in supported_tiers"

- name:                                "5.1. Database Load - ORACLE: Show Main Memory"
  ansible.builtin.debug:
    msg:
      - "Total memory:         {{ main_mem1 }}"
      - "sga_max_size:         {{ ora_sga }}"
      - "pga_aggregate_target: {{ ora_pga }}"

- name:                                "5.1. Database Load - ORACLE: Set the SGA and PGA Sizes for RAM > 4TB"
  ansible.builtin.set_fact:
    ora_sga:                           "{{ (ansible_memory_mb.real.total * 0.65) | round | int }}"
    ora_pga:                           "{{ ((ansible_memory_mb.real.total*0.65)*0.2) | round | int }}"
  when:
    - ansible_memory_mb.real.total > 4194304
    - supported_tiers != "pas"
    - supported_tiers == "scs"

# Block to check if a reboot has been performed already after updating SGA & PGS
- name:                                "5.1. Database Load - ORACLE: DBLoad - check if DBLoad is performed for {{ sid_to_be_deployed.sid | upper }}"
  ansible.builtin.stat:
    path:                              "/etc/sap_deployment_automation/{{ sid_to_be_deployed.sid | upper }}/ora_sga_updated.txt"
  register:                            sga_update_status

- name:                                "5.1. Database Load - ORACLE: Oracle SGA Change Execution"
  become:                              true
  become_user:                         "{{ oracle_user_name }}"
  ansible.builtin.shell: |
                                       setenv ORACLE_SID {{ db_sid | upper }}
                                       $ORACLE_HOME/bin/sqlplus -S / as sysdba <<EOF
                                       ALTER SYSTEM SET sga_max_size={{ ora_sga }}M SCOPE=spfile;
                                       ALTER SYSTEM SET pga_aggregate_target={{ ora_pga }}M SCOPE=spfile;
                                       ALTER SYSTEM SET use_large_pages=only SCOPE=spfile;
                                       alter system set LOCAL_LISTENER="(ADDRESS=(PROTOCOL=TCP)(HOST={{ ansible_hostname }})(PORT=1521))" scope=both;
                                       SHUTDOWN IMMEDIATE;
                                       EXIT;
                                       EOF
  register:                            updatesga_results
  failed_when:                         updatesga_results.rc != 0
  args:
    creates:                           "/etc/sap_deployment_automation/{{ sid_to_be_deployed.sid | upper }}/ora_sga_updated.txt"
    executable:                        /bin/csh


- name:                                "5.1. Database Load - ORACLE - Check for zombie standby processes"
  become_user:                         "root"
  become:                              true
  ansible.builtin.shell: |
                                       set -o pipefail
                                       ps -ef | grep ora_pmon_{{ db_sid | upper }} | grep -v grep || true
  register:                            standby_pmon
  changed_when:                        false

- name:                                "5.1. Database Load - ORACLE - Kill zombie standby processes"
  become:                              true
  become_user:                         root
  ansible.builtin.shell:               kill -9 {{ item.split()[1] }}
  loop:                                "{{ standby_pmon.stdout_lines }}"
  when:                                standby_pmon.stdout | length > 0
  failed_when:                         false

- name:                                "5.1. Database Load - ORACLE - Clean orphaned shared memory segments"
  become:                              true
  become_user:                         root
  ansible.builtin.shell: |
                                       set -o pipefail
                                       for seg in $(ipcs -m | grep {{ oracle_user_name }} | awk '$6==0 {print $2}'); do
                                         ipcrm -m $seg
                                       done
  failed_when:                         false
  when:                                standby_pmon.stdout | length > 0

- name:                               "5.1. Database Load - ORACLE - Debug: SGA Change Output"
  ansible.builtin.copy:
    dest:                             "/etc/sap_deployment_automation/oracle/updatesga_results.log"
    content:                          "{{ updatesga_results.stdout }}"
    mode:                              0755
  when:                                updatesga_results.stdout is defined

- name:                                "5.1. Database Load - ORACLE - Create ora_sga_updated.txt"
  ansible.builtin.file:
    path:                              "/etc/sap_deployment_automation/{{ sid_to_be_deployed.sid | upper }}/ora_sga_updated.txt"
    state:                             touch
    mode:                              '0755'
  when:
    - updatesga_results.stdout is defined
    - updatesga_results.rc == 0

- name:                                "5.1. Database Load - ORACLE - Start Oracle after SGA Change"
  become:                              true
  become_user:                         "{{ oracle_user_name }}"
  ansible.builtin.shell: |
                                       setenv ORACLE_SID {{ db_sid | upper }}
                                       $ORACLE_HOME/bin/sqlplus -S / as sysdba <<EOF
                                       STARTUP MOUNT;
                                       EXIT;
                                       EOF
  register:                            dbstarted_results
  failed_when:                         false
  args:
    executable:                        /bin/csh
  when:
    - updatesga_results.stdout is defined
    - updatesga_results.rc == 0

- name:                                "5.1. Database Load - ORACLE - Start lsnrctl on Primary"
  become:                              true
  become_user:                         "{{ oracle_user_name }}"
  ansible.builtin.shell:               $ORACLE_HOME/bin/lsnrctl reload
  register:                            lsnrctl_start_primary_results
  failed_when:                         lsnrctl_start_primary_results.rc > 1
  args:
    executable:                        /bin/csh
