# /*---------------------------------------------------------------------------8
# |                                                                            |
# |                          Role to process the BOM                           |
# |                                                                            |
# +------------------------------------4--------------------------------------*/
# Description:  Downloads the files specified in BOM file from SAP to the
#               ansible controller and uploads them to the storage account.
#
#
# Objects:
#   External:
#             sapbits_location_base_path      - URL of Blob Storage
#             sapbits_bom_files               - path to the root of the sap file store
#             bom_base_name                   - Name of BOM
#             sapbits_sas_token               - SAS Token
#             download_directory              - Path to the download location on the ansible controller
#
#   Internal:
#             result                          - objet to store the results of a task execution
#
#   Created:
#             bom                             - object containing the specified BOM
#
# -------------------------------------+---------------------------------------8
# Reviews:
#
#
# -------------------------------------+---------------------------------------8
---
# -------------------------------------+---------------------------------------8
#
# Description:  Validation for Prerequisites
#
- name:                                "0.1 BoM Validator: - Pre-checks"
  import_tasks:                        pre_checks.yaml
# -------------------------------------+---------------------------------------8

# -------------------------------------+---------------------------------------8
#
# Description:  Create BOM download directories".
#

- name:                                "0.1 BoM Validator: - Create BOM download directories"
  ansible.builtin.file:
    path:                              "{{ item.path }}"
    state:                             directory
    mode:                              0755
  become:                              true
  become_user:                         root
  loop:
    - path: "{{ download_directory }}"
    - path: "{{ download_directory }}/tmp"
    - path: "{{ download_directory }}/bom"
    - path: "{{ download_directory }}/files"

- name:                                "0.1 BoM Validator: - BoM Initial file"
  ansible.builtin.copy:
    dest:                              "{{ download_directory }}/readme.md"
    content:                           "This is the container with the SAP media"
    mode:                              0755
  register:                            readme_file
  become:                              true
  become_user:                         root

- name:                                "0.1 BoM Validator: - Check storage account container"
  ansible.builtin.command: >-
                                       az storage blob upload
                                         --account-name {{ account }}
                                         --account-key {{ sapbits_access_key }}
                                         --container-name {{ container }}
                                         --name readme.md
                                         --file {{ readme_file.dest }}
                                         --if-none-match "*"
                                         --no-progress
  delegate_to:                         localhost
  register:                            azresult
  ignore_errors:                       true
  changed_when:                        false
  failed_when:
    - azresult.rc != 0
    - azresult.stderr is defined
    - azresult.stderr.find("BlobAlreadyExists") == -1


# -------------------------------------+---------------------------------------8
#
# Description:  Call BOM processor, passing BOM name.
#
# TODO:
#       Enhance so a single task loops over bas bom and dependencies
#
- name:                                "0.1 BoM Validator: - Process main BoM"
  include_tasks:                       bom_validator.yaml
  vars:
    account:                           "{{ sapbits_location_base_path.rpartition('//')[2].split('.')[0] }}"
    container:                         "{{ sapbits_location_base_path.rpartition('//')[2].split('/')[1] }}/{{ sapbits_bom_files }}/archives"
    bom_name:                          "{{ bom_base_name }}"
# -------------------------------------+---------------------------------------8

# -------------------------------------+---------------------------------------8
#
# Description:  Call BOM processor, passing dependent BOM names.
#
- name:                                "0.1 BoM Validator: - Process dependent BoMs"
  include_tasks:                       bom_validator.yaml
  vars:
    account:                           "{{ sapbits_location_base_path.rpartition('//')[2].split('.')[0] }}"
    container:                         "{{ sapbits_location_base_path.rpartition('//')[2].split('/')[1] }}/{{ sapbits_bom_files }}/archives"
    bom_name:                          "{{ bom_dependency.name }}"
  loop:                                "{{ bom.materials.dependencies | flatten(levels=1) }}"
  loop_control:
    loop_var:                          bom_dependency
  when:
    - bom.materials.dependencies is defined
    - bom.materials.dependencies|length>0
# -------------------------------------+---------------------------------------8

# /*---------------------------------------------------------------------------8
# |                                   END                                      |
# +------------------------------------4--------------------------------------*/

- name:                                "0.1 BoM Validator: - BoM folder path"
  ansible.builtin.debug:
    msg:                               "{{ sapbits_location_base_path }}/{{ sapbits_bom_files }}/boms/{{ bom_base_name }}/{{ bom_base_name }}.yaml"


...
