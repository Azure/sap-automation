# /*-----------------------------------------------------------------------------------------------------8
# |                                                                                                                                         |
# |                 Perform the DB2 Instance installation                                                           |
# |                  SAP: Register BOM                                                                                       |
# |                  SAP DB2 :  create .params directory                                                             |
# |                  Export  environment variables for DB2 Installation                                      |
# |                  Run SWPM to Install DB2                                                                             |
# |                   TODO; Mention any OSS notes here                                                            |
# |                                                                                                                                          |
# +------------------------------------4--------------------------------------------------------------- */

# TODO: Considerations

---

- name:                               "DB2:  Single Instance Installation "
  import_tasks:                     4.2.0.1-db2_single_instance_install.yml
  when:                                 db_high_availability == false    


- name:                                 "DB2:  High Availability  Installation"
  block:

    - name:                              "DB2:  High Availability  Installation on Primary "
      import_tasks:                   4.2.0.2-db2_ha_install_primary.yml

    - name:                              "DB2:  Create  backup of Primary DB after Install"
      import_tasks:                   4.2.0.3-db2_primary_backup.yml 
              
    - name:                             "DB2:  High Availability  Installation on Secondary Using Backup/Restore"
      import_tasks:                   4.2.0.4-db2_ha_install_secondary.yml
    - name:                            "DB2 Install: Include roles-sap/3.3.1-bom-utility role"
      ansible.builtin.include_role:
        name:                          roles-sap/3.3.1-bom-utility
        tasks_from:                    bom-template
      vars:
        bom_name:                      "{{ bom_base_name }}"
        db2_archive_path:              /usr/sap/install/sapdb2_software
        db2_cd_package_exportcd:       "/usr/sap/install/CD_EXPORT/DATA_UNITS"
        db2_cd_package_db2client:      "{{ db2_archive_path }}/db2client"
        db2_cd_package_software:       "{{ db2_archive_path }}/db2server/LINUXX86_64"
        db2_cd_package_kernel:         /usr/sap/install/download_basket/
        sap_db_hostname:               "{{ query('inventory_hostnames', '{{ sap_sid|upper }}_DB')  | first }}"
        db2_encryption_algo_type:      "AES"
        db2_ase_encryption_length:     "256"
        db2_encryption_keystore_dir:   /db2/db2{{ db_sid }}/keystore
        db2_sslencryption_label:       "sap_db2{{ db_sid }}_{{ sap_db_hostname }}_ssl_comm_000"
        sap_scs_hostname:               "{{ query('inventory_hostnames', '{{ sap_sid|upper }}_SCS')  | first }}"
         
      tags:
        - skip_ansible_lint
# +------------------------------------4--------------------------------------*/

    # - name:                            "SAP DB2 install: variables"
    #   ansible.builtin.debug:
    #     msg:
    #       - "{{ sap_inifile }}"
    #       - "{{ bom.product_ids.dbl }}"
    #   verbosity:                     2
# *====================================4=======================================8
#   SAP DB2: Install
#   2230669 - System Provisioning Using a Parameter Input File
#

    - name:                               "DB2:  Restore Standby/Secondary with the backup of Primary"
      import_tasks:                    4.2.0.5-db2_restore_secondary.yml

  when:                                   db_high_availability == true
    - name:                            "DB2 Install: flag"
      ansible.builtin.file:
        path:                          /etc/sap_deployment_automation/sap_deployment_db2.txt
        state:                         touch
        mode:                          0755

    - name:                            "Set LOCK variable for PAS"                  #2570458 - DB6: Depooling report RUTPOADAPT fails with SQL -912
      become:                          true
      become_user:                     db2{{ db_sid| lower }}
      ansible.builtin.command:         db2set DB2_AVOID_LOCK_ESCALATION=FALSE
      args:
        creates:                       /etc/sap_deployment_automation/lock_escalation_false.txt
      register:                        db2_lock_escalation
    
    - name:                            "Create lock escalation run flag"
      ansible.builtin.file:
        path:                          /etc/sap_deployment_automation/lock_escalation_false.txt
        state:                         touch
        mode:                          0755 
      when:                            db2_lock_escalation.rc == 0
      

  when:
    - not db2_installed.stat.exists
# *====================================4=======================================8

...

# /*---------------------------------------------------------------------------8
# |                                   END                                      |
# +------------------------------------4--------------------------------------*/
