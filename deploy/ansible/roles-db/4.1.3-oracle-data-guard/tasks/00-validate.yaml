---

- name:                                "4.1.3 Oracle Data Guard - Setup Primary: - Test network connectivity to peer"
  ansible.builtin.wait_for:
    host:                              "{{ hostvars[item]['ansible_host'] }}"
    port:                              "{{ listener_port }}"
    timeout:                           10
  loop:                                 "{{ ansible_play_hosts_all }}"
  when:                                item != inventory_hostname
  delegate_to:                         localhost

- name:                                "4.1.3 Oracle Data Guard - Check ASM status"
  become_user:                         "{{ grid_user_name }}"
  when:                                node_tier == "oracle-asm"
  become:                              true
  ansible.builtin.shell: |
                                       sqlplus / as sysasm <<EOF
                                       SET PAGESIZE 0 FEEDBACK OFF
                                       SELECT name || ':' || state FROM v\$asm_diskgroup;
                                       EXIT;
                                       EOF

  register:                            asm_status
  environment:                         "{{ grid_env }}"
  changed_when:                        false
  args:
    chdir:                             "/etc/sap_deployment_automation/dataguard_scripts/"

- name:                                "4.1.3 Oracle Data Guard - Show ASM mounted disk groups"
  ansible.builtin.debug:
    msg:                               "ASM Disk group Status: {{ asm_status.stdout }}"
  when:
    - node_tier == "oracle-asm"
    - asm_status is defined

- name:                                "4.1.3 Oracle Data Guard - Setup Primary: -Validate ASM mounted disk groups"
  ansible.builtin.assert:
    that:                              "'MOUNTED' in asm_status.stdout"
    fail_msg:                          "ASM disk groups not mounted"
  when:
    - node_tier == "oracle-asm"
    - asm_status is defined

- name:                                "4.1.3 Oracle Data Guard -  Check if Primary instance is open"
  when:                                ansible_hostname == ora_primary
  block:

    - name:                            "4.1.3 Oracle Data Guard - Verify Status on Primary"
      become_user:                     "{{ oracle_user_name }}"
      become:                          true
      ansible.builtin.shell: |
                                       sqlplus -S / as sysdba <<EOF
                                       SET PAGESIZE 0 FEEDBACK OFF HEADING OFF;
                                       SELECT database_role || ':' || open_mode FROM v\$database;
                                       EXIT;
                                       EOF

      register:                        dg_status
      changed_when:                    false
      failed_when:                     false
      args:
        chdir:                         "/etc/sap_deployment_automation/dataguard_scripts/"
      environment:                     "{{ oracle_env }}"

    - name:                            "4.1.3 Oracle Data Guard - Set status on Primary"
      ansible.builtin.set_fact:
        primary_open:                  "{{ ((dg_status.stdout | default('UNKNOWN')) is search('PRIMARY:READ WRITE')) | bool }}"

    - name:                            "4.1.3 Oracle Data Guard - Show status on Primary"
      ansible.builtin.debug:
        msg:
          - "Database instance:        {{ ansible_hostname }}"
          - "Primary instance open:    {{ primary_open }}"
          - "Database role and open mode: {{ dg_status.stdout }}"

    - name:                            "4.1.3 Oracle Data Guard - Open Primary"
      when:                            not primary_open
      become_user:                     "{{ oracle_user_name }}"
      become:                          true
      ansible.builtin.shell: |
                                       sqlplus -S / as sysdba <<EOF
                                       ALTER DATABASE OPEN;
                                       EXIT;
                                       EOF

      register:                        db_opened
      changed_when:                    false
      failed_when:                     false
      environment:                     "{{ oracle_env }}"
      args:
        chdir:                         "/etc/sap_deployment_automation/dataguard_scripts/"

    - name:                            "4.1.3 Oracle Data Guard - Verify Data Guard configuration on Primary"
      when:                            not primary_open
      become_user:                     "{{ oracle_user_name }}"
      become:                          true
      ansible.builtin.shell: |
                                       sqlplus -S / as sysdba <<EOF
                                       SET PAGESIZE 0 FEEDBACK OFF HEADING OFF;
                                       SELECT database_role || ':' || open_mode FROM v\$database;
                                       EXIT;
                                       EOF

      register:                        dg_status
      changed_when:                    false
      failed_when:                     false
      environment:                     "{{ oracle_env }}"
      args:
        chdir:                         "/etc/sap_deployment_automation/dataguard_scripts/"

    - name:                            "4.1.3 Oracle Data Guard - Set Data Guard configuration status on Primary"
      when:                            not primary_open
      ansible.builtin.set_fact:
        primary_open:                  "{{ ((dg_status.stdout | default('UNKNOWN')) is search('PRIMARY:READ WRITE')) | bool }}"

    - name:                            "4.1.3 Oracle Data Guard - Display Data Guard status on Primary"
      ansible.builtin.debug:
        msg:
          - "Database instance:        {{ ansible_hostname }}"
          - "Primary instance open:    {{ primary_open }}"

- name:                                "4.1.3 Oracle Data Guard -  Check if Data Guard is configured"
  when:                                ansible_hostname == ora_secondary
  block:

    - name:                            "4.1.3 Oracle Data Guard - Check Database status on Secondary {{ ansible_hostname }}"
      become_user:                     "{{ oracle_user_name }}"
      become:                          true
      ansible.builtin.shell: |
                                       sqlplus -S / as sysdba <<EOF
                                       SET PAGESIZE 0 FEEDBACK OFF HEADING OFF;
                                       SELECT database_role || ',' || open_mode || ',' || db_unique_name FROM v\$database;
                                       EXIT;
                                       EOF
      environment:                     "{{ oracle_env }}"
      args:
        chdir:                         "/etc/sap_deployment_automation/dataguard_scripts/"
      register:                        rman_performed
      changed_when:                    false
      failed_when:                     false

    - name:                            "4.1.3 Oracle Data Guard - Display Data Guard status"
      ansible.builtin.debug:
        msg:                           "Database role: {{ rman_performed.stdout | default('UNKNOWN') }}"

    - name:                            "4.1.3 Oracle Data Guard - Set Data Guard configuration status"
      ansible.builtin.set_fact:
        secondary_duplicated:          "{{ (rman_performed.stdout | default('UNKNOWN')) is search('PHYSICAL STANDBY')  }}"

    - name:                            "4.1.3 Oracle Data Guard - Display Data Guard status"
      ansible.builtin.debug:
        msg:
          - "Database instance:        {{ ansible_hostname }}"
          - "Data duplicated:          {{ secondary_duplicated }}"

...
