# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

---

- name:                                "4.1.3 Oracle Data Guard: Setting the Current host name"
  ansible.builtin.set_fact:
    current_host:                      "{{ ansible_hostname }}"

- name:                                "4.1.3 Oracle Data Guard - Preparation: Create folders"
  become:                              true
  become_user:                         "root"
  ansible.builtin.file:
    path:                              "{{ item.path }}"
    state:                             directory
    owner:                             "{{ oracle_user_name }}"
    group:                             oinstall
    mode:                              "{{ item.mode }}"
  loop:
    - { mode: '0775', path: '/etc/sap_deployment_automation' }
    - { mode: '0775', path: '/etc/sap_deployment_automation/dataguard_scripts' }
    - { mode: '0775', path: '/oracle/{{ db_sid | upper }}/saptrace' }
    - { mode: '0775', path: '/oracle/{{ db_sid | upper }}/saparch' }
    - { mode: '0775', path: '/oracle/{{ db_sid | upper }}/sapprof' }
    - { mode: '0775', path: '/oracle/{{ db_sid | upper }}/sapcheck' }
    - { mode: '0775', path: '/oracle/{{ db_sid | upper }}/saptrace/audit' }
    - { mode: '0775', path: '/oracle/{{ db_sid | upper }}/saptrace/background' }
    - { mode: '0775', path: '/oracle/{{ db_sid | upper }}/saptrace/diag' }
    - { mode: '0775', path: '/oracle/{{ db_sid | upper }}/saptrace/usertrace' }
    - { mode: '0775', path: '{{ target_media_location }}/downloads/{{ sap_sid | upper }}' }
    - { mode: '0775', path: '{{ target_media_location }}/downloads/{{ sap_sid | upper }}/dbs' }


- name:                                "4.1.3 Oracle Data Guard: - Set sid variable"
  ansible.builtin.set_fact:
    this_sid:                          "{{ db_sid | upper }}"

- name:                                "4.1.3 Oracle Data Guard: - Set sid variable Secondary"
  ansible.builtin.set_fact:
    this_sid:                          "{{ db_sid | upper }}_STDBY"
  when:
    - ansible_hostname == ora_secondary

- name:                                "4.1.3 Oracle Data Guard: - Preparation Create password file"
  when:
                                       - tier != "observer"
  become:                              true
  become_user:                         "{{ oracle_user_name }}"

  ansible.builtin.shell:               "orapwd file=$ORACLE_HOME/dbs/orapw{{ db_sid | upper }}_STDBY password='{{ main_password }}' entries=5 format=12 force=y"
  environment:
    ORACLE_SID:                        "{{ this_sid }}"
    ORACLE_HOME:                       "/oracle/{{ db_sid | upper }}/{{ ora_version }}"
  args:
    creates:                           /oracle/{{ db_sid | upper }}/{{ ora_version }}/dbs/orapw{{ this_sid }}
    executable:                        /bin/csh
    chdir:                             "/oracle/{{ db_sid | upper }}/{{ ora_version }}/bin"

- name:                                "4.1.3 Oracle Data Guard: - Validate"
  when:
    - ora_primary == ansible_hostname
  ansible.builtin.include_tasks:       "00-validate-primary.yaml"

- name:                                "4.1.3 Oracle Data Guard: - Validate Secondary/Standby"
  when:
    - ora_secondary == ansible_hostname
  ansible.builtin.include_tasks:       "00-validate-secondary.yaml"


- name:                                "4.1.3 Oracle Data Guard: - Prepare primary node"
  when:
    - ora_primary == ansible_hostname
  ansible.builtin.include_tasks:       "01-prepare-primary.yaml"

- name:                                "4.1.3 Oracle Data Guard: - Prepare secondary node"
  when:
    - ora_secondary == ansible_hostname
    - not secondary_duplicated
  ansible.builtin.include_tasks:       "02-prepare-secondary.yaml"

- name:                                "4.1.3 Oracle Data Guard - Test connectivity primary -> standby"
  become_user:                         "{{ oracle_user_name }}"
  become:                              true
  when:                                inventory_hostname == ora_primary
  block:
    - name:                            "4.1.3 Oracle Data Guard - Test connectivity primary -> standby"
      ansible.builtin.shell: |
                                       sqlplus -S sys/'{{ main_password }}'@{{ db_sid | upper }}_STDBY as sysdba <<EOF
                                       SELECT 'connected' FROM dual;
                                       EXIT;
                                       EOF
      register:                        conn_test
      changed_when:                    false
      failed_when:                     false
      environment:                     "{{ oracle_env }}"
      args:
        chdir:                         "/oracle/{{ db_sid | upper }}/{{ ora_version }}/bin"

    - name:                            "4.1.3 Oracle Data Guard - Test connectivity primary -> standby - Assert"
      ansible.builtin.fail:
        msg:                           "Could not connect from primary to standby database. Please check tnsnames.ora and listener configuration."
      when:
        - "'connected' not in conn_test.stdout"

    - name:                            "4.1.3 Oracle Data Guard - Test connectivity primary -> standby - Assert"
      ansible.builtin.assert:
        that:
          - "'connected' in conn_test.stdout"
        fail_msg:                   "Could not connect from primary to standby database. Please check tnsnames.ora and listener configuration."


- name:                                "4.1.3 Oracle Data Guard - Test connectivity standby -> primary"
  become_user:                         "{{ oracle_user_name }}"
  become:                              true
  when:                                inventory_hostname == ora_secondary
  block:
    - name:                            "4.1.3 Oracle Data Guard - Test connectivity standby -> primary"
      ansible.builtin.shell: |
                                       sqlplus -S sys/'{{ main_password }}'@{{ db_sid | upper }} as sysdba <<EOF
                                       SELECT 'connected' FROM dual;
                                       EXIT;
                                       EOF
      register:                        conn_test_reverse
      changed_when:                    false
      failed_when:                     false
      environment:                     "{{ oracle_standby_env }}"
      args:
        chdir:                         "/oracle/{{ db_sid | upper }}/{{ ora_version }}/bin"

    - name:                            "4.1.3 Oracle Data Guard - Test connectivity standby -> primary"
      ansible.builtin.fail:
        msg:                           "Could not connect from standby to primary database. Please check tnsnames.ora and listener configuration."
      when:
        - "'connected' not in conn_test_reverse.stdout"

    - name:                            "4.1.3 Oracle Data Guard - Test connectivity standby -> primary"
      ansible.builtin.assert:
        that:
          - "'connected' in conn_test_reverse.stdout"
        fail_msg:                      "Could not connect from standby to primary database. Please check tnsnames.ora and listener configuration."

- name:                                "4.1.3 Oracle Data Guard: - Duplicate the database"
  when:
    - ora_secondary == ansible_hostname
    - not secondary_duplicated
  ansible.builtin.include_tasks:       "03-duplicate-database.yaml"

- name:                            "4.1.3 Oracle Data Guard - Test connectivity primary -> standby - Assert"
  ansible.builtin.fail:
    msg:                           "Could not connect from primary to standby database. Please check tnsnames.ora and listener configuration."


- name:                                "4.1.3 Oracle Data Guard: - Configure Data Guard on Primary"
  when:
    - ora_primary == ansible_hostname
    - hostvars[ora_secondary].secondary_duplicated | default(false)
  ansible.builtin.include_tasks:       "04-postdeployment-primary.yaml"

- name:                                "4.1.3 Oracle Data Guard: - Configure Data Guard on Secondary"
  when:
    - ora_secondary == ansible_hostname
    - secondary_duplicated | default(false)
  ansible.builtin.include_tasks:       "04-postdeployment-secondary.yaml"

- name:                                "4.1.3 Oracle Data Guard: - Finalize"
  ansible.builtin.include_tasks:       "05-finalize.yaml"

...
# /*---------------------------------------------------------------------------8
# |                                   END                                      |
# +------------------------------------4--------------------------------------*/
