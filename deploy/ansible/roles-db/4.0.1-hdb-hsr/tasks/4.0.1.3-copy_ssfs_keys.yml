# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

---

# /*---------------------------------------------------------------------------8
# |                                                                            |
# |     Copy SSFS Keys                                                         |
# |                                                                            |
# +------------------------------------4--------------------------------------*/

- name:                                "HANA HSR: - Define SSFS file locations"
  ansible.builtin.set_fact:
    ssfs_files:
      - { file: "SSFS_{{ hana_tenant_database_name }}.DAT", folder: "/usr/sap/{{ hana_tenant_database_name }}/SYS/global/security/rsecssfs/data/", mode: '640', type: 'rsecssfs' }
      - { file: "SSFS_{{ hana_tenant_database_name }}.KEY", folder: "/usr/sap/{{ hana_tenant_database_name }}/SYS/global/security/rsecssfs/key/", mode: '600', type: 'rsecssfs' }
    xsa_ssfs_files:
      - { file: "SSFS_{{ hana_tenant_database_name }}.DAT", folder: "/usr/sap/{{ hana_tenant_database_name }}/SYS/global/xsa/security/ssfs/data/", mode: '640', type: 'xsa' }
      - { file: "SSFS_{{ hana_tenant_database_name }}.KEY", folder: "/usr/sap/{{ hana_tenant_database_name }}/SYS/global/xsa/security/ssfs/key/", mode: '600', type: 'xsa' }

# ----------------------------------------
# Copy required SSFS files (always present)
# ----------------------------------------

- name:                                "HANA HSR: - Fetch required SSFS files from Primary to Controller"
  when:                                ansible_hostname == primary_instance_name
  ansible.builtin.fetch:
    src:                               "{{ item.folder }}{{ item.file }}"
    dest:                              /tmp/{{ item.type }}/
    flat:                              true
  loop:                                "{{ ssfs_files }}"

- name:                                "HANA HSR: - Copy required SSFS files from Controller to Secondary"
  when:                                ansible_hostname == secondary_instance_name
  ansible.builtin.copy:
    src:                               /tmp/{{ item.type }}/{{ item.file }}
    dest:                              "{{ item.folder }}"
    mode:                              "{{ item.mode }}"
    owner:                             "{{ db_sid_admin_user }}"
    group:                             "{{ hana_group }}"
  loop:                                "{{ ssfs_files }}"

# ----------------------------------------
# Copy optional XSA SSFS files (if present)
# ----------------------------------------

- name:                                "HANA HSR: - Check if XSA SSFS files exist on Primary"
  when:                                ansible_hostname == primary_instance_name
  ansible.builtin.stat:
    path:                              "{{ xsa_ssfs_files[0].folder }}{{ xsa_ssfs_files[0].file }}"
  register:                            xsa_ssfs_check

- name:                                "HANA HSR: - Display XSA SSFS file check result"
  when:
                                       - ansible_hostname == primary_instance_name
                                       - xsa_ssfs_check is defined
  ansible.builtin.debug:
    msg:                               "XSA SSFS files {{ 'exist' if xsa_ssfs_check.stat.exists else 'do not exist' }} on primary node"
    verbosity:                         2

- name:                                "HANA HSR: - Copy XSA SSFS files if they exist"
  when:
                                       - xsa_ssfs_check is defined
                                       - xsa_ssfs_check.stat.exists
  block:
    - name:                            "HANA HSR: - Fetch XSA SSFS files from Primary to Controller"
      when:                            ansible_hostname == primary_instance_name
      ansible.builtin.fetch:
        src:                           "{{ item.folder }}{{ item.file }}"
        dest:                          /tmp/{{ item.type }}/
        flat:                          true
      loop:                            "{{ xsa_ssfs_files }}"

    - name:                            "HANA HSR: - Copy XSA SSFS files from Controller to Secondary"
      when:                            ansible_hostname == secondary_instance_name
      ansible.builtin.copy:
        src:                           /tmp/{{ item.type }}/{{ item.file }}
        dest:                          "{{ item.folder }}"
        mode:                          "{{ item.mode }}"
        owner:                         "{{ db_sid_admin_user }}"
        group:                         "{{ hana_group }}"
      loop:                            "{{ xsa_ssfs_files }}"
