# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

# /*---------------------------------------------------------------------------8
# |                                                                            |
# |                Perform the Oracle Instance ASM installation                    |
# |                  SAP: Register BOM                                         |
# |                  create .params directory                                  |
# |                  Export environment variables for Oracle Installation      |
# |                  Run the Oracle universal installer in silent mode.        |
# |                   SAP Note : 2660017 Oracle Software Installation on Unix  |
# |                                                                            |
# +------------------------------------4--------------------------------------*/

# TODO: Considerations
#         15G+ swap space for Oracle DB installation.
#         MAke the installer more version independent
#

---

- name:                                "4.1.1. ORACLE Grid Setup - Register BoM"
  ansible.builtin.include_role:
    name:                              roles-sap/3.3.1-bom-utility
    tasks_from:                        bom-register
  vars:
    bom_name:                          "{{ bom_base_name }}"
    task_prefix:                       "ORACLEGrid"
    sa_enabled:                        true
  when:
                                       - bom is undefined

- name:                                "4.1.1. ORACLE Grid Setup - Validate ORACLE parameters"
  ansible.builtin.assert:
    that:
      - item_to_check.parameter is defined                    # Has the variable been defined
      - item_to_check.parameter | type_debug != 'NoneType'    # and given a value
      - item_to_check.parameter | trim | length > 1
    fail_msg:                      item_to_check.error
  loop:
    - { parameter: 'bom.patch_information.ora_release', error: 'Oracle deployments requires that ora_release is provided' }
    - { parameter: 'bom.patch_information.ora_version', error: 'Oracle deployments requires that ora_version is provided' }
    - { parameter: 'bom.patch_information.oracle_sbp_patch', error: 'Oracle deployments requires that oracle_sbp_patch is provided' }
  loop_control:
    loop_var: item_to_check

- name:                                "4.1.1. ORACLE Grid Setup - Set variables from BoM"
  ansible.builtin.set_fact:
    ora_release:                       "{{ bom.patch_information.ora_release }}"
    ora_version:                       "{{ bom.patch_information.ora_version }}"
    oracle_sbp_patch:                  "{{ bom.patch_information.oracle_sbp_patch }}"

- name:                                "4.1.1. ORACLE Grid Setup - Load the disk configuration settings"
  ansible.builtin.include_vars:        disks_config_asm.yml

- name:                                "4.1.1. ORACLE Grid Setup - Create directories"
  ansible.builtin.file:
    path:                              "{{ item.path }}"
    state:                             directory
    mode:                              "{{ item.mode }}"
    owner:                             "{{ grid_user_name }}"
    group:                             oinstall
    recurse:                           "{{ item.recurse }}"
  loop:
    - { state: 'directory', mode: '0755', recurse: false, path: '/etc/sap_deployment_automation/' }
    - { state: 'directory', mode: '0755', recurse: false, path: '/etc/sap_deployment_automation/grid' }
    - { state: 'directory', mode: '0775', recurse: false, path: "/oracle/BASE" }
    - { state: 'directory', mode: '0775', recurse: false, path: "/oracle/BASE/crsdata" }
    - { state: 'directory', mode: '0775', recurse: true,  path: "/oracle/oraInventory" }

- name:                                "4.1.1. ORACLE Grid Setup - Check if installed"
  ansible.builtin.stat:
    path:                              "/etc/sap_deployment_automation/grid/grid_setup_completed.txt"
  register:                            grid_installed

# - fail:
#     msg:   "check before grid post processing"

# +------------------------------------4--------------------------------------*/
# |                                                                            |
# |                       Oracle Grid: Response file                           |
# |                                                                            |
# +------------------------------------4--------------------------------------*/

- name:                                "4.1.1. ORACLE Grid Setup - Install status"
  when:
    - not grid_installed.stat.exists
  block:

    - name:                            "4.1.1. ORACLE Grid Setup - Get the List of Data disks"
      become:                          true
      become_user:                     root
      ansible.builtin.shell:           "set -o pipefail && oracleasm listdisks | grep DATA"
      register:                        asm_disk_list

    - name:                            "4.1.1. ORACLE Grid Setup - Get the List of ARCH disks"
      become:                          true
      become_user:                     root
      ansible.builtin.shell:           "set -o pipefail && oracleasm listdisks | grep ARCH"
      register:                        asm_archive_disk_list

    - name:                            "4.1.1. ORACLE Grid Setup - Get the List of RECO disks"
      become:                          true
      become_user:                     root
      ansible.builtin.shell:           "set -o pipefail && oracleasm listdisks |grep RECO"
      register:                        asm_recovery_disk_list

    - name:                            "4.1.1. ORACLE Grid Setup - Prepare the Data disk list"
      ansible.builtin.set_fact:
        asm_disk_list:                "{{ asm_disk_list.stdout_lines | list }}"
        asm_archive_disk_list:        "{{ asm_archive_disk_list.stdout_lines | list }}"
        asm_recovery_disk_list:       "{{ asm_recovery_disk_list.stdout_lines | list }}"

    - name:                            "4.1.1. ORACLE Grid Setup - Display disk lists"
      ansible.builtin.debug:
        msg:
          - "Data:     {{ asm_disk_list }}"
          - "Archive:  {{ asm_archive_disk_list }}"
          - "Recovery: {{ asm_recovery_disk_list }}"

    - name:                            "4.1.1. ORACLE Grid Setup - Prepend /dev/oracleasm/disk to each of of the disk"
      ansible.builtin.set_fact:
        asm_data_disk_list:            "{{ asm_disk_list | map('regex_replace', '^(.*)$', '/dev/oracleasm/disks/\\1') | join(',') }}"
        asm_archive_disk_list:         "{{ asm_archive_disk_list | map('regex_replace', '^(.*)$', '/dev/oracleasm/disks/\\1') | join(',') }}"
        asm_recovery_disk_list:        "{{ asm_recovery_disk_list | map('regex_replace', '^(.*)$', '/dev/oracleasm/disks/\\1') | join(',') }}"
      when:
        - is_UEK6

    - name:                            "4.1.1. ORACLE Grid Setup - Prepend ORCL: to each of of the disk"
      ansible.builtin.set_fact:
        asm_data_disk_list:            "{{ asm_disk_list | map('regex_replace', '^(.*)$', 'ORCL:\\1') | join(',') }}"
        asm_archive_disk_list:         "{{ asm_archive_disk_list | map('regex_replace', '^(.*)$', 'ORCL:\\1') | join(',') }}"
        asm_recovery_disk_list:        "{{ asm_recovery_disk_list | map('regex_replace', '^(.*)$', 'ORCL:\\1') | join(',') }}"
      when:
        - not is_UEK6

    - name:                            "4.1.1. ORACLE Grid Setup - Store the disk lists as arrays"
      ansible.builtin.set_fact:
        data_disk_list:                "{{ asm_data_disk_list | split(',') | list }}"
        arch_disk_list:                "{{ asm_archive_disk_list | split(',') | list }}"
        recovery_disk_list:            "{{ asm_recovery_disk_list | split(',') | list }}"

    - name:                            "4.1.1. ORACLE Grid Setup - Display Oracle lists with prefix"
      ansible.builtin.debug:
        msg:
          - "Data:     {{ data_disk_list }}"
          - "Archive:  {{ arch_disk_list }}"
          - "Recovery: {{ recovery_disk_list }}"

    - name:                            "4.1.1. ORACLE Grid Setup - Create Grid install response file"
      become:                          true
      become_user:                     "{{ grid_user_name }}"
      ansible.builtin.template:
        src:                           ORACLE_19c_00_ASM_v1_install.rsp.j2
        dest:                          "/oracle/GRID/{{ ora_version }}/{{ ansible_hostname }}_{{ db_sid }}_install.rsp"
        mode:                          '0644'
        force:                         true
      vars:
        _is_UEK6:                      "{{ is_UEK6 | default(false) }}"


# +------------------------------------4--------------------------------------*/
# |                                                                            |
# |                       Oracle Grid: Install software                        |
# |                                                                            |
# +------------------------------------4--------------------------------------*/

    - name:                            "4.1.1. ORACLE Grid Setup - Unzip the Grid software"
      become:                          true
      become_user:                     root
      ansible.builtin.unarchive:
        src:                           "{{ target_media_location }}/oraserver/LINUX_X86_64/grid_home/{{ oracle_grid_home_zip }}"
        dest:                          /oracle/GRID/{{ ora_version }}
        creates:                       "/oracle/GRID/{{ ora_version }}/SIGNATURE.SMF"
        owner:                         "{{ grid_user_name }}"
        group:                         oinstall
        remote_src:                    true

    - name:                            "4.1.1. ORACLE Grid Setup - Install RPM Packages"
      ansible.builtin.dnf:
        name:                          "/oracle/GRID/{{ ora_version }}/cv/rpm/cvuqdisk-1.0.10-1.rpm"
        state:                         present
        disable_gpg_check:             true

# +------------------------------------4--------------------------------------*/
# |                                                                            |
# |                       Oracle Grid: Patch installation media                |
# |                                                                            |
# +------------------------------------4--------------------------------------*/

    - name:                            "4.1.1. ORACLE Grid Setup - Find Patch ID for Database Release Update"
      become:                          true
      become_user:                     root
      ansible.builtin.find:
        paths:                         "{{ target_media_location }}/SBP/GIRU19P"
        patterns:                      ["bundle.xml"]
        file_type:                     file
        recurse:                       true
      register:                        patch_grid_id_directory

    - name:                            "4.1.1. ORACLE Grid Setup - Find Patch ID for Database Release Update"
      ansible.builtin.fail:
        msg:                           "No Database Release Update found"
      when:                            patch_grid_id_directory.matched != 1

    - name:                            "4.1.1. ORACLE Grid Setup - Save OPatch ID"
      ansible.builtin.set_fact:
        patch_grid_path:               "{{ patch_grid_id_directory.files[0].path | dirname }}"
      when:                            patch_grid_id_directory.matched == 1

    - name:                            "4.1.1. ORACLE Grid Setup - Show OPatch ID"
      ansible.builtin.debug:
        msg:                           "Patch GRID path {{ patch_grid_path }}"

    - name:                            "4.1.1. ORACLE Grid Setup - Set STAGE_SBP_DBRU"
      ansible.builtin.set_fact:
        STAGE_SBP_DBRU:                "{{ patch_grid_path }}/{{ bom.patch_information.SBP_DBRU }}"
      when:                            patch_grid_path is defined and bom.patch_information.SBP_DBRU is defined

    - name:                            "4.1.1. ORACLE Grid Setup - Set STAGE_SBP_OCWRU"
      ansible.builtin.set_fact:
        STAGE_SBP_OCWRU:               "{{ patch_grid_path }}/{{ bom.patch_information.SBP_OCWRU }}"
      when:                            patch_grid_path is defined and bom.patch_information.SBP_OCWRU is defined

    - name:                            "4.1.1. ORACLE Grid Setup - Set STAGE_SBP_ACFSRU"
      ansible.builtin.set_fact:
        STAGE_SBP_ACFSRU:              "{{ patch_grid_path }}/{{ bom.patch_information.SBP_ACFSRU }}"
      when:                            patch_grid_path is defined and bom.patch_information.SBP_ACFSRU is defined

    - name:                            "4.1.1. ORACLE Grid Setup - Set OneOffs"
      ansible.builtin.set_fact:
        OneOffs:                       "{{ STAGE_SBP_OCWRU }},{{ STAGE_SBP_ACFSRU }}"
      when:
                                      - STAGE_SBP_OCWRU is defined
                                      - STAGE_SBP_ACFSRU is defined

    - name:                            "4.1.1. ORACLE Grid Setup - Set ApplyRU and OPatchPath"
      ansible.builtin.set_fact:
        OPatchPath:                    "{{ target_media_location }}/SBP/OPATCH/OPatch"
        ApplyRU:                       "{{ STAGE_SBP_DBRU }}"
        OHGRID:                        "/oracle/GRID/{{ ora_version }}"

    - name:                            "4.1.1. ORACLE Grid Setup - Installation parameters"
      ansible.builtin.debug:
        msg:
          - "STAGE_SBP_DBRU :  {{ STAGE_SBP_DBRU }}"
          - "STAGE_SBP_OCWRU:  {{ STAGE_SBP_OCWRU }}"
          - "STAGE_SBP_ACFSRU: {{ STAGE_SBP_ACFSRU }}"
          - "OneOffs:          {{ OneOffs }}"
          - "OPatchPath:       {{ OPatchPath }}"
          - "ApplyRU:          {{ ApplyRU }}"

    # Backup the existing OPatch and then copy the new Patch from the downloads folder

    - name:                            "4.1.1. ORACLE Grid Setup - Create unique name for OPatch backup"
      ansible.builtin.set_fact:
        patch_copy_name:               "/oracle/GRID/{{ ora_version }}/OPatch.{{ '%Y%m%d' | strftime(0) }}"

    - name:                            "4.1.1. ORACLE Grid Setup - Check if backup exists for GRID"
      ansible.builtin.stat:
        path:                          "{{ patch_copy_name }}"
      register:                        opatchgrid_stat

    - name:                            "4.1.1. ORACLE Grid Setup - Backup OPatch"
      ansible.builtin.copy:
        src:                           "/oracle/GRID/{{ ora_version }}/OPatch"
        dest:                          "{{ patch_copy_name }}"
        remote_src:                    true
        mode:                          '0755'
        owner:                         "{{ grid_user_name }}"
        group:                         oinstall
      when:
        - not opatchgrid_stat.stat.exists

    - name:                            "4.1.1. ORACLE Grid Setup - Remove old OPatch"
      ansible.builtin.file:
        path:                          "/oracle/GRID/{{ ora_version }}/OPatch"
        state:                         absent

    - name:                            "4.1.1. ORACLE Grid Setup - Copy OPatch for GRID from downloads"
      ansible.builtin.copy:
        src:                           "{{ target_media_location }}/SBP/OPATCH/OPatch"
        dest:                          "/oracle/GRID/{{ ora_version }}"
        remote_src:                    true
        mode:                          '0755'
        owner:                         "{{ grid_user_name }}"
        group:                         oinstall

    - name:                            "4.1.1. ORACLE Grid Setup - Find MOPatch"
      ansible.builtin.find:
        paths:                          "{{ target_media_location }}/SBP/SGR19P"
        patterns:                       ["MOPatch"]
        file_type:                      directory
        recurse:                        true
      register:                         mopatch_directory

    - name:                            "4.1.1. ORACLE Grid Setup - Too many MOPatches found"
      ansible.builtin.fail:
        msg:                           "Too many MOPatches found"
      when:                            mopatch_directory.matched > 1

    - name:                            "4.1.1. ORACLE Grid Setup - No MOPatch found"
      ansible.builtin.fail:
        msg:                           "No MOPatches found"
      when:                            mopatch_directory.matched == 0

    - name:                            "4.1.1. ORACLE Grid Setup - MOPatch path"
      ansible.builtin.set_fact:
        mopatch_path:                  "{{ mopatch_directory.files[0].path }}"
      when:                            mopatch_directory.matched == 1

    - name:                            "4.1.1. ORACLE Grid Setup - Copy MOPatch for GRID"
      ansible.builtin.copy:
        src:                           "{{ mopatch_path }}"
        dest:                          "/oracle/GRID/{{ ora_version }}"
        remote_src:                    true
        mode:                          '0755'
        owner:                         "{{ grid_user_name }}"
        group:                         oinstall

    # +--------------------------------4------------------------------------------*/
    # |                                                                            |
    # |                       Oracle Grid: Perform installation                    |
    # |                                                                            |
    # +--------------------------------4------------------------------------------*/

    - name:                            "4.1.1. ORACLE Grid Setup - Show gridSetup command"
      ansible.builtin.debug:
        msg:                           "Running ./gridSetup.sh -silent -applyRU {{ ApplyRU }} -applyOneOffs {{ OneOffs }} -opatchlocation /oracle/GRID/{{ ora_version }}/OPatch -skipOpatchVersionCheck -responseFile ./{{ ansible_hostname }}_{{ db_sid }}_install.rsp"

    - name:                            "4.1.1. ORACLE Grid Setup - Execute gridSetup.sh"
      become:                          true
      become_user:                     "{{ grid_user_name }}"
      ansible.builtin.shell: |
                                       ./gridSetup.sh -silent -applyRU {{ ApplyRU }} -applyOneOffs {{ OneOffs }} -opatchlocation /oracle/GRID/{{ ora_version }}/OPatch -skipOpatchVersionCheck -ignorePrereqFailure -responseFile ./{{ ansible_hostname }}_{{ db_sid }}_install.rsp
      register:                        gridinstaller_results
      failed_when:                     gridinstaller_results.rc >= 2              # installer returns rc=1 (exited with warning) by default when run is silent mode as the oratab file is created only after running the root.sh
      environment:
        CV_ASSUME_DISTID:              "{{ CV_ASSUME_DISTID }}"
        ORACLE_BASE:                   /oracle/BASE
        ORACLE_HOME:                   /oracle/GRID/{{ ora_version }}
      args:
        executable:                    /bin/csh
        chdir:                         "/oracle/GRID/{{ ora_version }}"
        creates:                       /etc/sap_deployment_automation/grid/grid_install.txt

    - name:                            "4.1.1. ORACLE Grid Setup - Save gridSetup.sh output"
      ansible.builtin.copy:
        dest:                          "/etc/sap_deployment_automation/grid/grid_install.log"
        content:                       "{{ gridinstaller_results.stdout }}"
        mode:                          0777
      when:                            gridinstaller_results.stdout is defined

    - name:                            "4.1.1. ORACLE Grid Setup - Create after a successful GRID install"
      ansible.builtin.file:
        path:                          "/etc/sap_deployment_automation/grid/grid_install.txt"
        state:                         touch
        mode:                          '0755'

    # +--------------------------------4------------------------------------------*/
    # |                                                                            |
    # |                       Oracle Grid: Post processing                         |
    # |                                                                            |
    # +--------------------------------4------------------------------------------*/

    - name:                            "4.1.1. ORACLE Grid Setup - Oracle Post Processing - Run root.sh"
      become:                          true
      become_user:                     root
      ansible.builtin.shell: |
                                       /oracle/oraInventory/orainstRoot.sh
      register:                        orainstRoot_results
      args:
        executable:                    /bin/csh
        creates:                       /etc/sap_deployment_automation/grid/orainstRoot_rootscript.txt

    - name:                            "4.1.1. ORACLE Grid Setup - Debug: orainstRoot.sh output"
      ansible.builtin.copy:
        dest:                          "/etc/sap_deployment_automation/grid/orainstRoot.log"
        content:                       "{{ orainstRoot_results.stdout }}"
        mode:                          0777
      when:                            orainstRoot_results.stdout is defined

    - name:                            "4.1.1. ORACLE Grid Setup - Create after a successful post processing oraInstRoot script execution"
      ansible.builtin.file:
        path:                          /etc/sap_deployment_automation/grid/orainstRoot_rootscript.txt
        state:                         touch
        mode:                          '0755'

    - name:                            "4.1.1. ORACLE Grid Setup - Oracle Post Processing - Run GRID root.sh"
      become:                          true
      become_user:                     root
      ansible.builtin.shell: |
                                       /oracle/GRID/{{ ora_version }}/root.sh
      register:                        grid_rootscript_results
      args:
        executable:                    /bin/csh
        creates:                       "/etc/sap_deployment_automation/grid/gridinstall_rootscript.txt"

    - name:                            "4.1.1. ORACLE Grid Setup - Debug: GRID root.sh output"
      ansible.builtin.copy:
        dest:                          "/etc/sap_deployment_automation/grid/gridroot.log"
        content:                       "{{ grid_rootscript_results.stdout }}"
        mode:                          0777
      when:                            grid_rootscript_results.stdout is defined

    - name:                            "4.1.1. ORACLE Grid Setup - Create after a successful root script execution"
      ansible.builtin.file:
        path:                          "/etc/sap_deployment_automation/grid/gridinstall_rootscript.txt"
        state:                         touch
        mode:                          '0755'

    # +--------------------------------4------------------------------------------*/
    # |                                                                            |
    # |                       Oracle Grid: Execute Config tools                    |
    # |                                                                            |
    # +--------------------------------4------------------------------------------*/

    - name:                            "4.1.1. ORACLE Grid Setup - Show gridSetup ASM Config command"
      ansible.builtin.debug:
        msg:                           "Running ./gridSetup.sh -executeConfigTools -silent -responseFile ./{{ ansible_hostname }}_{{ db_sid }}_install.rsp"

    - name:                            "4.1.1. ORACLE Grid Setup - Execute ASM Config tools"
      become:                          true
      become_user:                     "{{ grid_user_name }}"
      ansible.builtin.shell: |
                                       ./gridSetup.sh -executeConfigTools -silent -responseFile ./{{ ansible_hostname }}_{{ db_sid }}_install.rsp
      register:                        tools_installer_results
      failed_when:                     tools_installer_results.rc >= 2              # installer returns rc=1 (exited with warning) by default when run is silent mode as the oratab file is created only after running the root.sh
      environment:
        DB_SID:                        "{{ db_sid }}"
        CV_ASSUME_DISTID:              "{{ CV_ASSUME_DISTID }}"
        ORACLE_SID:                    "{{ db_sid | upper }}"
        ORACLE_BASE:                   /oracle/BASE
        ORACLE_HOME:                   /oracle/GRID/{{ ora_version }}
      args:
        executable:                    /bin/csh
        chdir:                         /oracle/GRID/{{ ora_version }}/
        creates:                       /etc/sap_deployment_automation/grid/asm_tools_install.txt

    - name:                            "4.1.1. ORACLE Grid Setup - Debug: gridSetup.sh executeConfigTools output"
      ansible.builtin.copy:
        dest:                          "/etc/sap_deployment_automation/grid/asm_tools_install.log"
        content:                       "{{ tools_installer_results.stdout }}"
        mode:                          0755
      when:                            tools_installer_results.stdout is defined

    - name:                            "4.1.1. ORACLE Grid Setup - Create after a successful Config tool execution"
      ansible.builtin.file:
        path:                          "/etc/sap_deployment_automation/grid/asm_tools_install.txt"
        state:                         touch
        mode:                          '0755'


# - fail:
#     msg:   "check before creating additional ASM Disk groups"

    # +--------------------------------4------------------------------------------*/
    # |                                                                            |
    # |           Oracle Grid: Create ARCH and RECO disk groups using ASMCA        |
    # |                                                                            |
    # +--------------------------------4------------------------------------------*/

    - name:                            "4.1.1. ORACLE Grid Setup - Create ASM Disk groups ARCH"
      become:                          true
      become_user:                     "{{ grid_user_name }}"
      ansible.builtin.shell: |
                                       ./asmca -silent -createDiskGroup -diskGroupName ARCH -redundancy EXTERNAL -diskList '{{ asm_archive_disk_list }}' \
                                         -compatible.asm {{ ora_version }} -compatible.rdbms  {{ ora_version }} -compatible.advm {{ ora_version }}

      register:                        arch_diskgroup_creation_results
      environment:
        DB_SID:                        "{{ db_sid | upper }}"
        CV_ASSUME_DISTID:              "{{ CV_ASSUME_DISTID }}"
      args:
        executable:                    /bin/csh
        chdir:                         "/oracle/GRID/{{ ora_version }}/bin"
        creates:                       /etc/sap_deployment_automation/grid/diskgroups_created.txt

    - name:                            "4.1.1. ORACLE Grid Setup - Create ASM Disk groups RECO"
      become:                          true
      become_user:                     "{{ grid_user_name }}"
      ansible.builtin.shell: |
                                       set -o errexit
                                       ./asmca -silent -createDiskGroup -diskGroupName RECO -redundancy EXTERNAL -diskList '{{ asm_recovery_disk_list }}' \
                                         -compatible.asm {{ ora_version }} -compatible.rdbms  {{ ora_version }} -compatible.advm {{ ora_version }}
      register:                        reco_diskgroup_creation_results
      environment:
        DB_SID:                        "{{ db_sid | upper }}"
        CV_ASSUME_DISTID:              "{{ CV_ASSUME_DISTID }}"
      args:
        executable:                    /bin/csh
        chdir:                         "/oracle/GRID/{{ ora_version }}/bin"
        creates:                       /etc/sap_deployment_automation/grid/diskgroups_created.txt

    - name:                            "4.1.1. ORACLE Grid Setup - Created after a successful disk group creation"
      ansible.builtin.file:
        path:                          "/etc/sap_deployment_automation/grid/diskgroups_created.txt"
        state:                         touch
        mode:                          '0755'

    - name:                            "4.1.1. ORACLE Grid Setup - Create after a successful grid deployment"
      ansible.builtin.file:
        path:                          "/etc/sap_deployment_automation/grid/grid_setup_completed.txt"
        state:                         touch
        mode:                          '0755'

- name:                                "4.1.1. ORACLE Grid Setup - Install status"
  when:
    - grid_installed.stat.exists
  block:

    - name:                            "4.1.1. ORACLE Grid Setup - Install status"
      ansible.builtin.debug:
        msg:                           "4.1.1. ORACLE Grid Setup - is already installed"

    - name:                            "4.1.1. ORACLE Grid Setup - Set return value"
      ansible.builtin.set_fact:
        oracle_grid_already_installed:      true

# - name:                               "SAP Oracle DB ASM: Update ASM Disk groups ARCH and RECO for DBLOAD"
#   become:                             true
#   become_user:                        oracle
#   ansible.builtin.shell: |
#                                       set -o errexit
#                                       ./asmca -silent -editDiskGroupAttributes -diskGroupName DATA -attribute compatible.advm={{ ora_version }}
#                                       ./asmca -silent -editDiskGroupAttributes -diskGroupName DATA -attribute compatible.rdbms={{ ora_version }}
#                                       ./asmca -silent -editDiskGroupAttributes -diskGroupName DATA -attribute compatible.asm={{ ora_version }}
#   register:                           diskgroupupdate_results
#   failed_when:                        diskgroupupdate_results.rc >= 1
#   environment:
#     DB_SID:                           "{{ db_sid }}"
#     CV_ASSUME_DISTID:                 "{{ CV_ASSUME_DISTID }}"
#   args:
#     executable:                       /bin/csh
#     chdir:                            /oracle/GRID/{{ ora_version }}/bin
#     creates:                          /etc/sap_deployment_automation/grid/diskgroupupdated.txt

# - name:                               "SAP Oracle DB ASM: Create flag after a sucessfull change"
#   ansible.builtin.file:
#     path:                             /etc/sap_deployment_automation/grid/diskgroupupdated.txt
#     state:                            touch
#     mode:                             '0755'


# - name:                               "SAP Oracle Fail before DB Install"
#   ansible.builtin.fail:
#     msg:   "check before DB install"
...
# /*---------------------------------------------------------------------------8
# |                                   END                                      |
# +------------------------------------4--------------------------------------*/
