---
# DGMGRL Config on Primary

# # Set Primary and Secondary node names.
# - name:                        Setting the primary and Secondary DB names
#   ansible.builtin.set_fact:
#     ora_primary:                "{{ ansible_play_hosts_all[0] }}"         # Oracle Primary Host
#     ora_secondary:              "{{ ansible_play_hosts_all[1] }}"         # Oracle Secondary Host
#     current_host:               "{{ ansible_hostname }}"

- name:                                " Check SAP Restore on secondary is completed"
  ansible.builtin.stat:
    path:                              /usr/sap/install/downloads/restore_completed.txt
  register:                            secondary_completed
  when:                                node_tier == 'oracle'

- name: "Execute Block only if secondary DB restore is completed"
  block:

  # Restart the LSNRCTL START
  - name:                                "Oracle Data Guard - Post Processing: Restart lsnrctl on Primary"
    become:                              true
    become_user:                         "oracle"
    ansible.builtin.shell:               lsnrctl reload
    register:                            lsnrctl_start_primary_results
    failed_when:                         lsnrctl_start_primary_results.rc > 0
    args:
      creates:                           /etc/sap_deployment_automation/dgscripts/lsnrctl_started_primary.txt
      chdir:                             /etc/sap_deployment_automation/dgscripts
      executable:                        /bin/csh
    #when:                                current_host == ora_primary
  
  - name:                                "Oracle Data Guard - Post Processing: Create lsnrctl_started_sec.txt"
    become:                              true
    become_user:                         "oracle"
    ansible.builtin.file:
      path:                              /etc/sap_deployment_automation/dgscripts/lsnrctl_started_primary.txt
      state:                             touch
      mode:                              0755
    #when:                                current_host == ora_primary
  
  - name:                                "Oracle Data Guard - Post Processing: Start DG Broker on Primary"
    become:                              true
    become_user:                         "oracle"
    ansible.builtin.shell:               sqlplus / as sysdba @enabledgbroker.sql  | tee /etc/sap_deployment_automation/dgscripts/enabledgbroker.log
    register:                            secondarystartup_results
    failed_when:                         secondarystartup_results.rc > 0
    args:
      creates:                           /etc/sap_deployment_automation/dgscripts/enabledgbroker.txt
      chdir:                             /etc/sap_deployment_automation/dgscripts
      executable:                        /bin/csh
    #when:                                current_host == ora_primary
  
  - name:                                "Oracle Data Guard - Post Processing: Create enabledgbroker.txt"
    become:                              true
    become_user:                         "oracle"
    ansible.builtin.file:
      path:                              /etc/sap_deployment_automation/dgscripts/enabledgbroker.txt
      state:                             touch
      mode:                              0755
    #when:                                current_host == ora_primary
  
  - name:                                "Oracle Data Guard - Post Processing: Create dgmgrl configuration on Primary"
    become:                              true
    become_user:                         "oracle"
    ansible.builtin.shell:               dgmgrl / as sysdba @dgconfig.dgmgrl  | tee /etc/sap_deployment_automation/dgscripts/dgcreate.log
    register:                            dgconfig_results
    failed_when:                         dgconfig_results.rc > 0
    args:
      creates:                           /etc/sap_deployment_automation/dgscripts/dgconfig.txt
      chdir:                             /etc/sap_deployment_automation/dgscripts
      executable:                        /bin/csh
    #when:                                current_host == ora_primary
  
  - name:                                "Oracle Data Guard - Post Processing: Create dgconfig.txt"
    become:                              true
    become_user:                         "oracle"
    ansible.builtin.file:
      path:                              /etc/sap_deployment_automation/dgscripts/dgconfig.txt
      state:                             touch
      mode:                              0755
   # when:                                current_host == ora_primary
  
  - name:                                "Oracle Data Guard - Post Processing: Enable dgmgrl configuration"
    become:                              true
    become_user:                         "oracle"
    ansible.builtin.shell:               dgmgrl / as sysdba "ENABLE CONFIGURATION"  | tee /etc/sap_deployment_automation/dgscripts/dgenable.log
    register:                            dgconfig_results
    failed_when:                         dgconfig_results.rc > 0
    args:
      creates:                           /etc/sap_deployment_automation/dgscripts/dgenable.txt
      chdir:                             /etc/sap_deployment_automation/dgscripts
      executable:                        /bin/csh
    #when:                                current_host == ora_primary
  
  - name:                                "Oracle Data Guard - Post Processing: Create dgenable.txt"
    become:                              true
    become_user:                         "oracle"
    ansible.builtin.file:
      path:                              /etc/sap_deployment_automation/dgscripts/dgenable.txt
      state:                             touch
      mode:                              0755


  - name:                                "Create post processing completed"
    become:                              true
    become_user:                         root
    ansible.builtin.file:
      path:                              /usr/sap/install/downloads/post_processing_completed.txt
      state:                             touch
      mode:                              0755
      owner: oracle
      group: oinstall

   
  when: 
    - secondary_completed.stat.exists

...
# /*---------------------------------------------------------------------------8
# |                                   END                                      |
# +------------------------------------4--------------------------------------*/