---
- name:                                "Oracle Data Guard - Observer: Set the NFS Server name"
  ansible.builtin.set_fact:
    nfs_server:                        "{{ query('inventory_hostnames', '{{ sap_sid|upper }}_SCS') | first }}"

# # Set Primary and Secondary node names.
# - name:                                "Set the  Server names"
#   ansible.builtin.set_fact:
#     ora_primary:                       "{{ sap_sid|upper }}_DB[0]"
#     ora_secondary:                     "{{ sap_sid|upper }}_DB[1]"
#     current_host:                      "{{ ansible_hostname }}"


# Mount Filesystems

- name:                                "Oracle Data Guard - Observer: Mount Filesystems block"
  block:
    - name:                            "Oracle Data Guard - Observer: Mount Filesystems when not using external NFS (on observer)"
      ansible.builtin.mount:
        src:                           "{{ item.src }}"
        path:                          "{{ item.path }}"
        fstype:                        "{{ item.type }}"
        opts:                          defaults
        state:                         mounted
      loop:
        - { type: 'nfs4',  src: '{{ nfs_server }}:{{ target_media_location }}',  path: '{{ target_media_location }}' }
      when:
        - node_tier == 'observer'
        - sap_mnt is undefined

- name:                                "Oracle Data Guard - Observer: Change group ID for oinstall"
  ansible.builtin.group:
    name:                              oinstall
    gid:                               "{{ oinstall_gid }}"

- name:                                "Oracle Data Guard - Observer: Change group ID for dba"
  ansible.builtin.group:
    name:                               dba
    gid:                                "{{ dba_gid }}"

- name:                                "Oracle Data Guard - Observer: Change UIDfor Oracle user"
  ansible.builtin.user:
    name:                              oracle
    uid:                               "{{ oracle_uid }}"
    group:                             oinstall
    groups:                            dba,racdba,oper,backupdba,dgdba,kmdba

- name:                                "Oracle Data Guard - Observer: Create sap_deployment_automation folder"
  become:                              true
  become_user:                         root
  ansible.builtin.file:
    path:                              /etc/sap_deployment_automation
    mode:                              0755
    state:                             directory
    owner:                             oracle
    group:                             oinstall

- name:                                "Oracle Data Guard - Observer: Create 'oracle' directory"
  ansible.builtin.file:
    path:                              /oracle
    mode:                              0755
    state:                             directory
    owner:                             oracle
    group:                             oinstall


- name:                                "Oracle Data Guard - Observer: Execute RUNINSTALLER"
  become:                              true
  become_user:                         "oracle"
  ansible.builtin.shell: |
                                       set -o errexit
                                       ./RUNINSTALLER  -ignorePrereqWarnings -silent |tee -a /etc/sap_deployment_automation/install.log
  register:                            orainstall_results
  failed_when:                         orainstall_results.rc >= 3
  environment:
    DB_SID:                            "{{ db_sid|upper }}"
    CV_ASSUME_DISTID:                  OL7
  args:
    executable:                        /bin/csh        
    chdir:                             "{{ target_media_location }}/oraserver/LINUX_X86_64/db_home/SAP"
    creates:                           /etc/sap_deployment_automation/oracleinstalled.txt

- name:                                "Oracle Data Guard - Observer: Create oracleinstalled.txt"
  become:                              true
  become_user:                         "oracle" 
  ansible.builtin.file:
    path:                              /etc/sap_deployment_automation/oracleinstalled.txt
    state:                             touch
    mode:                              0755

  #Create SQLNET.ORA .

- name:                                "Oracle Data Guard - Observer: Copy sqlnet.ora TO Observer"
  become:                              true
  become_user:                         "root"
  ansible.builtin.copy:
    src:                               "{{ target_media_location }}/downloads/sqlnet.ora"
    dest:                              /oracle/{{ db_sid }}/{{ ora_version }}/network/admin/sqlnet.ora
    remote_src:                        true
    owner:                             oracle
    group:                             oinstall


- name:                                "Oracle Data Guard - Observer: Copy tnsnames.ora TO Observer"
  become:                              true
  become_user:                         "root"
  ansible.builtin.copy:
    src:                               "{{ target_media_location }}/downloads/tnsnames.ora"
    dest:                              /oracle/{{ db_sid }}/{{ ora_version }}/network/admin/tnsnames.ora
    remote_src:                        true
    owner:                             oracle
    group:                             oinstall
  
  
- name:                                "Oracle Data Guard - Observer: Add environment variables to the Bash profile"
  become:                              true
  become_user:                         "oracle"
  ansible.builtin.blockinfile:
    path:                              /home/oracle/.bashrc
    insertafter:                       'fi '
    block: |
        #User Specific environment
        export ORACLE_HOME=/oracle/{{ db_sid|upper }}/{{ ora_version }}
        export ORACLE_SID={{ db_sid|upper }} 
        export ORACLE_BASE=/oracle
        export LD_LIBRARY_PATH=$ORACLE_HOME/lib
        export TNS_ADMIN=$ORACLE_HOME/network/admin
        export DB_SID={{ db_sid|upper }}
        PATH="$PATH:$ORACLE_HOME/bin"
        export PATH
  
- name:                                "Oracle Data Guard - Observer: create .cshrc"
  become:                              true
  become_user:                         "oracle"
  ansible.builtin.blockinfile:
    create:                            true
    path:                              /home/oracle/.cshrc
    marker_begin:                      "-- BEGIN"
    marker_end:                        "-- END"
    block: |
        #User Specific environment
        setenv  ORACLE_HOME /oracle/{{ db_sid|upper }}/{{ ora_release }}
        setenv  ORACLE_SID  {{ db_sid|upper }} 
        setenv  ORACLE_BASE /oracle
        setenv  LD_LIBRARY_PATH $ORACLE_HOME/lib
        setenv  TNS_ADMIN $ORACLE_HOME/network/admin
        setenv  DB_SID {{ db_sid|upper }}
        set path = ($path $ORACLE_HOME/bin)
    mode:                              0755

#Check if tnsping is working to reach Primary and Secondary databases.

# TNSPING FOR PRIMARY
- name:                                "Oracle Data Guard - Observer: Run tnsping on primary"
  become:                              true
  become_user:                         "oracle"
  ansible.builtin.shell:               tnsping {{ db_sid|upper }} |tee /etc/sap_deployment_automation/tnsping_primary.txt
  register:                            tnsping_primary_results
  args:
    chdir:                             /oracle/{{ db_sid|upper }}/{{ ora_release }}/bin
    executable:                        /bin/csh

# TNSPING FOR SECONDARY
- name:                                "Oracle Data Guard - Observer: Run tnsping on secondary"
  become:                              true
  become_user:                         "oracle"
  ansible.builtin.shell:               tnsping {{ db_sid|upper }}_STDBY |tee /etc/sap_deployment_automation/tnsping_secondary.txt
  register:                            tnsping_primary_results
  args:
    chdir:                             /oracle/{{ db_sid|upper }}/{{ ora_release }}/bin
    executable:                        /bin/csh

# ENABLE FSFO

#Create the DGMGRL Config file

- name:                                "Oracle Data Guard - Observer: Enable FSFO"
  become:                              true
  become_user:                         "oracle"
  ansible.builtin.template:
    backup:                            true
    src:                               enablefsfo.j2
    dest:                              "/etc/sap_deployment_automation/enablefsfo.dgmgrl"
    mode:                              0644
    force:                             true

- name:                                "Oracle Data Guard - Observer: Prepare for FSFO" 
  become:                              true
  become_user:                         "oracle"
  ansible.builtin.shell:               dgmgrl  sys/{{ main_password }}@{{ db_sid|upper }}  @enablefsfo.dgmgrl |tee /etc/sap_deployment_automation/fsfoprep.log
  register:                            fsfo_results
  failed_when:                         fsfo_results.rc > 0
  args:
    creates:                           /etc/sap_deployment_automation/fsfo_prepared.txt
    chdir:                             /etc/sap_deployment_automation/
    executable:                        /bin/csh

- name:                                "Oracle Data Guard - Observer: Create fsfo_prepared.txt"
  become:                              true
  become_user:                         "oracle" 
  ansible.builtin.file:
    path:                              /etc/sap_deployment_automation/fsfo_prepared.txt
    state:                             touch
    mode:                              0755

- name:                                "Oracle Data Guard - Observer: Enable FSFO" 
  become:                              true
  become_user:                         "oracle"
  ansible.builtin.shell:               dgmgrl  sys/{{ main_password }}@{{ db_sid|upper }}  "ENABLE FAST_START FAILOVER" |tee /etc/sap_deployment_automation/fsfoenable.log
  register:                            fsfo_results
  failed_when:                         fsfo_results.rc > 0
  args:
    creates:                           /etc/sap_deployment_automation/fsfo_enabled.txt
    chdir:                             /etc/sap_deployment_automation/
    executable:                        /bin/csh

- name:                                "Oracle Data Guard - Observer: Create fsfo_enabled.txt"
  become:                              true
  become_user:                         "oracle" 
  ansible.builtin.file:
    path:                              /etc/sap_deployment_automation/fsfo_enabled.txt
    state:                             touch
    mode:                              0755

- name:                                "Oracle Data Guard - Observer: Start FSFO Observer" 
  become:                              true
  become_user:                         "oracle"
  ansible.builtin.shell:               dgmgrl  sys/{{ main_password }}@{{ db_sid|upper }}  "START OBSERVER" &
  register:                            observer_results
  failed_when:                         observer_results.rc > 0
  args:
    creates:                           /etc/sap_deployment_automation/observerstarted.txt
    chdir:                             /etc/sap_deployment_automation/
    executable:                        /bin/csh

- name:                                "Oracle Data Guard - Observer: Create observerstarted.txt"
  become:                              true
  become_user:                         "oracle" 
  ansible.builtin.file:
    path:                              /etc/sap_deployment_automation/observerstarted.txt
    state:                             touch
    mode:                              0755

...
# /*---------------------------------------------------------------------------8
# |                                   END                                      |
# +------------------------------------4--------------------------------------*/