---

# /*---------------------------------------------------------------------------8
# |Execute the SQL scripts  for  data guard initial configuration.             |
# |                                                                            |
# |                                                                            |
# |                                                                            |
# +------------------------------------4--------------------------------------*/


# Set Primary and Secondary node names.
- name:                                "Oracle Data Guard - Setup Primary: Define variables"
  ansible.builtin.set_fact:
    ora_primary:                "{{ ansible_play_hosts_all[0] }}"         # Oracle Primary Host
    ora_secondary:              "{{ ansible_play_hosts_all[1] }}"         # Oracle Secondary Host
    current_host:               "{{ ansible_hostname }}"

# Steps to be run on Primary DB

- name:                                "Oracle Data Guard - Setup Primary: Check if archive_enabled_on_primary.txt exists"
  ansible.builtin.stat:
    path:                              /etc/sap_deployment_automation/dgscripts/archive_enabled_on_primary.txt
  register:                            archive_primary_stat
  when:  current_host == ora_primary

- name:                                "Oracle Data Guard - Setup Primary: Enable Archive log on Primary"  #In a typical SWPM installation archive log is always enabled.
  become:                              true
  become_user:                         "oracle"
  ansible.builtin.shell:               sqlplus / as sysdba @enablearchivelog.sql |tee /etc/sap_deployment_automation/dgscripts/enablearchive.log
  register:                            enablearchivelog_results
  failed_when:                         enablearchivelog_results.rc >= 2
  args:
    creates:                           /etc/sap_deployment_automation/dgscripts/archive_enabled_on_primary.txt
    chdir:                             /etc/sap_deployment_automation/dgscripts
    executable:                        /bin/csh
  when:
  #  - not archive_primary_stat.stat.exists
    - current_host == ora_primary

- name:                                "Oracle Data Guard - Setup Primary: Create archive_enabled_on_primary.txt"
  become:                              true
  become_user:                         "oracle"
  ansible.builtin.file:
    path:                              /etc/sap_deployment_automation/dgscripts/archive_enabled_on_primary.txt
    state:                             touch
    mode:                              0755
  when:  current_host == ora_primary

- name:                                "Oracle Data Guard - Setup Primary: Check if 'enable_force_login.txt' exists"
  ansible.builtin.stat:
    path:                              /etc/sap_deployment_automation/dgscripts/enable_force_login.txt
  register:                            forcelogin_stat
  when:  current_host == ora_primary

- name:                                "Oracle Data Guard - Setup Primary: Enable enable_force_login on Primary"
  become:                              true
  become_user:                         "oracle"
  ansible.builtin.shell:               sqlplus / as sysdba @enableforcelogging.sql |tee /etc/sap_deployment_automation/dgscripts/switcharchive.log
  register:                            enableforcelogging_results
  failed_when:                         enableforcelogging_results.rc >= 2
  args:
    creates:                           /etc/sap_deployment_automation/dgscripts/enable_force_login.txt
    chdir:                             /etc/sap_deployment_automation/dgscripts
    executable:                        /bin/csh
  when:
  #  - not forcelogin_stat.stat.exists
    - current_host == ora_primary

- name:                                "Oracle Data Guard - Setup Primary: Create enable_force_login.txt"
  become:                              true
  become_user:                         "oracle"
  ansible.builtin.file:
    path:                              /etc/sap_deployment_automation/dgscripts/enable_force_login.txt
    state:                             touch
    mode:                              0755
  when:  current_host == ora_primary

- name:                                "Oracle Data Guard - Setup Primary: Create oracle standbylog directory"
  ansible.builtin.file:
    path:                              /oracle/{{ db_sid|upper }}/oraarch/standbylog
    mode:                              0755
    state:                             directory
    owner:                             oracle
    group:                             oinstall
  when:  current_host == ora_primary

- name:                                "Oracle Data Guard - Setup Primary: Create standby logs for Oracle DG"
  become:                              true
  become_user:                         "oracle"
  ansible.builtin.shell:               sqlplus / as sysdba @standbyredologs.sql |tee /etc/sap_deployment_automation/dgscripts/standbylogs.log
  register:                            standbyredolog_results
  failed_when:                         standbyredolog_results.rc >= 2
  args:
    creates:                           /etc/sap_deployment_automation/dgscripts/standby_redo_logs.txt
    chdir:                             /etc/sap_deployment_automation/dgscripts
    executable:                        /bin/csh
  when:  current_host == ora_primary

- name:                                "Oracle Data Guard - Setup Primary: Create standby_redo_logs.txt"
  become:                              true
  become_user:                         "oracle"
  ansible.builtin.file:
    path:                              /etc/sap_deployment_automation/dgscripts/standby_redo_logs.txt
    state:                             touch
    mode:                              0755
  when:  current_host == ora_primary

- name:                                "Oracle Data Guard - Setup Primary: Enable Flashback on Oracle Primary DB"
  become:                              true
  become_user:                         "oracle"
  ansible.builtin.shell:               sqlplus / as sysdba @turnonflashback.sql |tee /etc/sap_deployment_automation/dgscripts/turn_on_flashback.log
  register:                            turn_on_flashback_results
  failed_when:                         turn_on_flashback_results.rc > 0
  args:
    creates:                           /etc/sap_deployment_automation/dgscripts/turn_on_flashback.txt
    chdir:                             /etc/sap_deployment_automation/dgscripts
    executable:                        /bin/csh
  when:  current_host == ora_primary

- name:                                "Oracle Data Guard - Setup Primary: Create turn_on_flashback.txt"
  become:                              true
  become_user:                         "oracle"
  ansible.builtin.file:
    path:                              /etc/sap_deployment_automation/dgscripts/turn_on_flashback.txt
    state:                             touch
    mode:                              0755
  when:  current_host == ora_primary

#STEP3 DGMGRL Config on Primary

# Restart the LSNRCTL START
# - name:                               "RESTART LSNRCTL ON PRIMARY"
#   become:                              true
#   become_user:                         "oracle"
#   ansible.builtin.shell:               lsnrctl reload
#   register:                            lsnrctl_start_primary_results
#   failed_when:                         lsnrctl_start_primary_results.rc > 0
#   args:
#     creates:                           /etc/sap_deployment_automation/dgscripts/lsnrctl_started_primary.txt
#     chdir:                             /etc/sap_deployment_automation/dgscripts
#     executable:                        /bin/csh
#   when:                                current_host == ora_primary

# - name:                                Create lsnrctl_started_sec.txt
#   become:                              true
#   become_user:                         "oracle"
#   ansible.builtin.file:
#     path:                              /etc/sap_deployment_automation/dgscripts/lsnrctl_started_primary.txt
#     state:                             touch
#     mode:                              0755
#   when:                                current_host == ora_primary


# - name:                                " DGMGRL CONFIG ON PRIMARY "
#   become:                              true
#   become_user:                         "oracle"
#   ansible.builtin.shell:               dgmgrl / as sysdba @dgconfig.dgmgrl  | tee /etc/sap_deployment_automation/dgscripts/dgcreate.log
#   register:                            dgconfig_results
#   failed_when:                         dgconfig_results.rc > 0
#   args:
#     creates:                           /etc/sap_deployment_automation/dgscripts/dgconfig.txt
#     chdir:                             /etc/sap_deployment_automation/dgscripts
#     executable:                        /bin/csh
#   when:                                current_host == ora_primary

# - name:                                Create dgconfig.txt
#   become:                              true
#   become_user:                         "oracle"
#   ansible.builtin.file:
#     path:                              /etc/sap_deployment_automation/dgscripts/dgconfig.txt
#     state:                             touch
#     mode:                              0755
#   when:                                current_host == ora_primary

...
# /*---------------------------------------------------------------------------8
# |                                   END                                      |
# +------------------------------------4--------------------------------------*/