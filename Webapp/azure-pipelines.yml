# This pipeline publishes and deploys the control plane UI

trigger:
- none

pool:
  vmImage: 'ubuntu-latest'

parameters:
  - name: webappName
    displayName: Web App Name
    type: string

variables:
  - group: "SAP-deployment-variables-keyvault"
  - group: "SAP-deployment-variables-specific"
  - group: "SAP-deployment-variables-general"
  - name: solution
    value: '**/*.sln'
  - name: buildPlatform
    value: Any CPU
  - name: buildConfiguration
    value: Release
  - name: webappName
    value: ${{ parameters.webappName }}

steps:
- task: DotNetCoreCLI@2
  inputs:
    command: 'build'
    projects: '$(System.DefaultWorkingDirectory)/**/*.csproj'

- task: DotNetCoreCLI@2
  inputs:
    command: 'publish'
    publishWebProjects: true

- task: AzureWebApp@1
  inputs:
    azureSubscription: $(AZURE_CONNECTION_NAME)
    appType: 'webAppLinux'
    appName: $(webappName)
    package: '$(System.DefaultWorkingDirectory)/**/*.zip'
    appSettings: '-AZURE_CLIENT_ID $(ARM_CLIENT_ID)
    -AZURE_CLIENT_SECRET $(ARM_CLIENT_SECRET) 
    -AZURE_TENANT_ID $(ARM_TENANT_ID)
    -CollectionUri $(System.CollectionUri)
    -Project $(System.TeamProject)
    -RepositoryId $(Build.Repository.ID)
    -PAT $(PAT)'
